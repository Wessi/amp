<?xml version="1.0"?>
<!DOCTYPE AMP [
<!ENTITY mondriandtd SYSTEM "mondrian.dtd">]>
<Schema name="AMP">
<Dimension name="Activity">
		<Hierarchy hasAll="true" primaryKey="amp_activity_id" primaryKeyTable="cached_amp_activity" allMemberCaption="#All_Activities#" allMemberName="All Activities" caption="#Activity#">
			<!-- Limit the activities showed to those belonging to the workspace selected  -->
			<Table name="cached_amp_activity">
				<SQL dialect="mysql"><![CDATA[cached_amp_activity.amp_activity_id IN (@donorquery)]]> </SQL>
			</Table>
			<Level name="Activity Title" column="name" table="cached_amp_activity" uniqueMembers="true" />
			<Level name="AMP ID" column="amp_id" table="cached_amp_activity" uniqueMembers="true" />
		</Hierarchy>
	</Dimension>
	<Dimension name="Pledges Dates" type="TimeDimension">
		  <Hierarchy hasAll="true" allMemberName="All Periods" allMemberCaption="#All_Pledges_Dates#" primaryKey="amp_fund_detail_id" caption="#Pledges_Dates#">
			   <View alias="v_pledges_date_hierarchy">
          <SQL dialect="mysql">
            <![CDATA[select * from v_pledges_date_hierarchy]]>
          </SQL>
        </View>
			 <Level name="Year" column="year" levelType="TimeYears" type="Numeric" />
			 <Level name="Quarter" column="quarter" ordinalColumn="quarter" nameColumn="quarter_name" levelType="TimeQuarters" type="Numeric" />
			 <Level name="Month" column="month" uniqueMembers="false" ordinalColumn="month" nameColumn="month_name" levelType="TimeMonths" type="Numeric"/>
		</Hierarchy>
	</Dimension>
	<Dimension name="Donor Dates" type="TimeDimension">
		<Hierarchy hasAll="true" allMemberName="All Periods" allMemberCaption="#All_Donor_Dates#" primaryKey="amp_fund_detail_id" caption="#Donor_Dates#">
			<Table name="cached_v_donor_date_hierarchy" />
				<Level name="Year" column="year" levelType="TimeYears" type="Numeric" />
				<Level name="Quarter" column="quarter" ordinalColumn="quarter" nameColumn="quarter_name" levelType="TimeQuarters" type="Numeric" />
				<Level name="Month" column="month" uniqueMembers="false" ordinalColumn="month" nameColumn="month_name" levelType="TimeMonths" type="Numeric"/>
		</Hierarchy>
	</Dimension>
	<Dimension name="Status">
		<Hierarchy hasAll="true" allMemberCaption="#All_Status#" allMemberName="All Status" primaryKey="amp_activity_id" caption="#Status#">
			<Table name="cached_v_status" />
			<Level name="name" column="name" table="cached_v_status" />
		</Hierarchy>
	</Dimension>
	
	<Cube name="Donor Funding">
		<Table name="cached_v_donor_funding">
			<SQL dialect="mysql"><![CDATA[cached_v_donor_funding.amp_activity_id IN (@donorquery)]]> </SQL>
		</Table>
		<Dimension name="Donor">
			<Hierarchy hasAll="true" allLevelName="All Donor" caption="#Donor#"
				allMemberCaption="#All_Donor#">
				<!-- No table element here. Fact table is assumed. -->
				<Level name="DonorName" column="donor_name">
					<NameExpression>
						<SQL dialect="mysql">
							IFNULL(donor_name,'#No_Data#')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
		<Dimension name="Donor Group">
			<Hierarchy hasAll="true" allLevelName="#All Donor Group" caption="#Donor_Group#" allMemberCaption="#All_Donor_Group#">
				<!-- No table element here. Fact table is assumed. -->
				<Level name="DonorGroup" column="org_grp_name">
					<NameExpression>
						<SQL dialect="mysql">
							IFNULL(org_grp_name,'#No_Data#')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
		<Dimension name="Donor Types" >
			<Hierarchy hasAll="true" allLevelName="All Donors types" caption="#Donors_types#" allMemberCaption="#All_Donors_types#">
				<!-- No table element here. Fact table is assumed. -->
				<Level name="DonorType" column="donor_type_name">
				<NameExpression>
						<SQL dialect="mysql">
							IFNULL(donor_type_name,'#No_Data#')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
		<Dimension name="Financing Instrument">
			<Hierarchy hasAll="true" allLevelName="All" allMemberCaption="#All_Financing_Instrument#" caption="#Financing_Instrument#">
				<!-- No table element here. Fact table is assumed. -->
				<Level name="Financing Instrument" column="financing_instrument_name">
					<NameExpression>
						<SQL dialect="mysql">
							IFNULL(financing_instrument_name,'#No_Data#')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
		<Dimension name="Terms of Assistance" caption="#Terms_of_Assistance#">
			<Hierarchy hasAll="true" allLevelName="All Terms of Assistance#" allMemberCaption="#All_Terms_of_Assistance#" caption="#Terms_of_Assistance#">
				<!-- No table element here. Fact table is assumed. -->
				<Level name="Terms of Assistance" column="terms_assist_name">
					<NameExpression>
						<SQL dialect="mysql">
							IFNULL(terms_assist_name,'#No_Data#')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
		<Dimension name="Primary Sector" foreignKey="amp_activity_id">
			<Hierarchy hasAll="true" allMemberCaption="#All_Primary_Sectors#" allMemberName="All Primary Sectors" primaryKey="amp_activity_id" caption="#Primary_Sector#">
				<Level name="Primary Sector Scheme" column="sec_scheme_name"/>
				<Level name="Primary Sector" column="p_sectorname">
				<NameExpression>
						<SQL dialect="mysql">
							IFNULL(p_sectorname,'#No_Data#')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
		<Dimension name="Regions">
		<Hierarchy hasAll="true" allMemberCaption="#All_Regions#" allMemberName="All Regions" primaryKey="amp_activity_id" caption="#Regions#">
			<Level name="Region" column="region">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(region,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	  </Dimension>
	  <Dimension name="Primary Program">
		<Hierarchy hasAll="true" allMemberCaption="#All_Programs#" allMemberName="All Programs" primaryKey="amp_activity_id" caption="#Primary_Program#">
			<Level name="Primary Program" column="primary_program_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(primary_program_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	  </Dimension>
	  <Dimension name="Secondary Program">
		<Hierarchy hasAll="true" allMemberCaption="#All_Programs#" allMemberName="All Programs" primaryKey="amp_activity_id" caption="#Secondary_Program#">
			<Level name="Secondary Program" column="secondary_program_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(secondary_program_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="National Program">
		<Hierarchy hasAll="true" allMemberCaption="#All_Programs#" allMemberName="All Programs" primaryKey="amp_activity_id" caption="#National_Program#">
			<Level name="National Program" column="national_program_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(national_program_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Sub-Sector">
		<Hierarchy hasAll="true" allMemberCaption="#All Sub-Sectors#" allMemberName="All Sub-Sectors" primaryKey="amp_activity_id" caption="#Sub-Sectors#">
			<Level name="sub-sector" column="p_sub_sector_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(p_sub_sector_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<!-- 
	<Dimension name="Currency">
		<Hierarchy hasAll="true" allMemberCaption="#All Currencies#" allMemberName="All Currencies" primaryKey="amp_activity_id" caption="#Currency#">
			<Level name="currency" column="currency_code">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(currency_code,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
			<level name="Amounts" column="raw_amount" formatter="org.digijava.module.mondrian.Formatter.CurrencyFormatter"/>
		</Hierarchy>
	</Dimension>
	 -->
		<DimensionUsage name="Activity" source="Activity" foreignKey="amp_activity_id" />
		<DimensionUsage name="Donor Dates" source="Donor Dates" foreignKey="amp_fund_detail_id" />
		<DimensionUsage name="Status" source="Status" foreignKey="amp_activity_id" />
		
		<Measure name="Actual Commitments" aggregator="sum" caption="#Actual_Commitments#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when cached_v_donor_funding.transaction_type=0
					and cached_v_donor_funding.adjustment_type=1 then
					cached_v_donor_funding.transaction_amount/getExchangeWithFixed(cached_v_donor_funding.currency_code,cached_v_donor_funding.transaction_date,cached_v_donor_funding.fixed_exchange_rate)
					else 0 end
				</SQL>
			</MeasureExpression>
		</Measure>
		<Measure name="Actual Disbursements" aggregator="sum" caption="#Actual_Disbursements#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when cached_v_donor_funding.transaction_type=1
					and cached_v_donor_funding.adjustment_type=1 then
					cached_v_donor_funding.transaction_amount/getExchangeWithFixed(cached_v_donor_funding.currency_code,cached_v_donor_funding.transaction_date,cached_v_donor_funding.fixed_exchange_rate)
					else 0 end
				</SQL>
			</MeasureExpression>
		</Measure>
		<Measure name="Activity Count" aggregator="distinct-count" column="amp_activity_id" caption="#Activity_Count#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter" />
		<Measure name="Actual Expenditures" aggregator="sum" caption="#Actual_Expenditures#">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when cached_v_donor_funding.transaction_type=2
					and cached_v_donor_funding.adjustment_type=1 then
					cached_v_donor_funding.transaction_amount/getExchangeWithFixed(cached_v_donor_funding.currency_code,cached_v_donor_funding.transaction_date,cached_v_donor_funding.fixed_exchange_rate)
					else 0 end
				</SQL>
			</MeasureExpression>
		</Measure>
		<Measure name="Planned Commitments" aggregator="sum" caption="#Planned_Commitments#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when cached_v_donor_funding.transaction_type=0
					and cached_v_donor_funding.adjustment_type=0 then
					cached_v_donor_funding.transaction_amount/getExchangeWithFixed(cached_v_donor_funding.currency_code,cached_v_donor_funding.transaction_date,cached_v_donor_funding.fixed_exchange_rate)
					else 0 end
				</SQL>
			</MeasureExpression>
		</Measure>
		<Measure name="Planned Disbursements" aggregator="sum" caption="#Planned_Disbursements#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when cached_v_donor_funding.transaction_type=1
					and cached_v_donor_funding.adjustment_type=0 then
					cached_v_donor_funding.transaction_amount/getExchangeWithFixed(cached_v_donor_funding.currency_code,cached_v_donor_funding.transaction_date,cached_v_donor_funding.fixed_exchange_rate)
					else 0 end
				</SQL>
			</MeasureExpression>
		</Measure>
		<Measure name="Planned Expenditures" aggregator="sum" caption="#Planned_Expenditures#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
					case when cached_v_donor_funding.transaction_type=2
					and cached_v_donor_funding.adjustment_type=0 then
					cached_v_donor_funding.transaction_amount/getExchangeWithFixed(cached_v_donor_funding.currency_code,cached_v_donor_funding.transaction_date,cached_v_donor_funding.fixed_exchange_rate)
					else 0 end
				</SQL>
			</MeasureExpression>
		</Measure>
	</Cube>
	
  <Cube name="Pledges Funding">
		<View alias="v_pledges_funding">
      <SQL dialect="mysql">
        <![CDATA[select * from v_pledges_funding]]>
      </SQL>
    </View>
	<Dimension name="Title">
		<Hierarchy hasAll="true" allLevelName="All Titles" caption="#Tilte#" allMemberCaption="#All_Titles#">
			<Level name="Title" column="title">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(title,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Donor">
		<Hierarchy hasAll="true" allLevelName="All Donor" caption="#Donor#" allMemberCaption="#All_Donor#">
			<Level name="DonorName" column="org_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(org_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Type of Assistance" caption="#Type_of_Assistance#">
		<Hierarchy hasAll="true" allLevelName="All Type of Assistance#" allMemberCaption="#All_Type_of_Assistance#" caption="#Type_of_Assistance#">
	  	<Level name="Type of Assistance" column="type_of_assistance_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(type_of_assistance_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Aid Modality" caption="#Aid_Modality#">
		<Hierarchy hasAll="true" allLevelName="All Aid Modality" allMemberCaption="#All_Aid_Modality#" caption="#Aid_Modality#">
	  	<Level name="Aid Modality" column="aid_modality_name">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(aid_modality_name,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Primary Sector" foreignKey="amp_activity_id">
		<Hierarchy hasAll="true" allMemberCaption="#All_Primary_Sectors#" allMemberName="All Primary Sectors"  caption="#Primary_Sector#">
			<Level name="Primary Sector" column="p_sectorname">
			<NameExpression>
					<SQL dialect="mysql">
						IFNULL(p_sectorname,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Regions">
		<Hierarchy hasAll="true" allMemberCaption="#All_Regions#" allMemberName="All Regions" caption="#Regions#">
			<Level name="Region" column="region">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(region,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>
	<Dimension name="Pledge Type">
		<Hierarchy hasAll="true" allMemberCaption="#All_Pledges_Types#" allMemberName="All Regions" caption="#Pledge_Type#">
			<Level name="Pledge Type" column="pledge_type">
				<NameExpression>
					<SQL dialect="mysql">
						IFNULL(pledge_type,'#No_Data#')
					</SQL>
				</NameExpression>
			</Level>
		</Hierarchy>
	</Dimension>

	<DimensionUsage name="Pledges Dates" source="Pledges Dates" foreignKey="amp_fund_detail_id" />
	
	<Measure name="Pledges" aggregator="sum" caption="#Total Pledges#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
		<MeasureExpression>
			<SQL dialect="mysql">
				v_pledges_funding.amount/getExchange(v_pledges_funding.currency_code,v_pledges_funding.transaction_date)
			</SQL>
		</MeasureExpression>
	</Measure>
	
	</Cube>
  
  <Cube name="Pledges Commitmens">
		<View alias="v_donor_funding">
      <SQL dialect="mysql">
        <![CDATA[select * from v_donor_funding WHERE NOT ISNULL(pledge_id)]]>
      </SQL>
    </View>
    
    <Measure name="Pledges Actual Commitments" aggregator="sum" caption="#Pledges Actual Commitments#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
				  case when transaction_type = 0 and adjustment_type =1  then
          transaction_amount / getExchangeWithFixed(currency_code, transaction_date,fixed_exchange_rate) 
          else 0  end
				</SQL>
			</MeasureExpression>
		</Measure>
    <Measure name="Pledges Actual Disbursements" aggregator="sum" caption="#Pledges Actual Disbursements#" formatter="org.digijava.module.mondrian.Formatter.TotalCellFormatter">
			<MeasureExpression>
				<SQL dialect="mysql">
				  case when transaction_type = 1 and adjustment_type =1 then
          transaction_amount / getExchangeWithFixed(currency_code, transaction_date,fixed_exchange_rate) 
          else 0  end
				</SQL>
			</MeasureExpression>
		</Measure>
  </Cube>
	<VirtualCube  name="Donor and Pledges">
	 <CubeUsages>
     <CubeUsage cubeName="Pledges Funding"/>
      <CubeUsage cubeName="Donor Funding"/>
      <CubeUsage cubeName="Pledges Commitmens"/>
    </CubeUsages>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Donor"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Aid Modality"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Type of Assistance"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Title"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Pledge Type"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Primary Sector"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Regions"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Donor"/>
    <VirtualCubeDimension  cubeName="Pledges Funding" name="Pledges Dates"/>
    <VirtualCubeDimension  cubeName="Donor Funding" name="Donor"/>
    
    <VirtualCubeMeasure  cubeName="Pledges Funding" name="[Measures].[Pledges]"/>
    <VirtualCubeMeasure  cubeName="Donor Funding" name="[Measures].[Actual Commitments]"/>
    <VirtualCubeMeasure  cubeName="Donor Funding" name="[Measures].[Actual Disbursements]"/>
    <VirtualCubeMeasure  cubeName="Pledges Commitmens" name="[Measures].[Pledges Actual Commitments]"/>
    <VirtualCubeMeasure  cubeName="Pledges Commitmens" name="[Measures].[Pledges Actual Disbursements]"/>
    
    <CalculatedMember  name="Commitment Gap" dimension="Measures" caption="#Commitment Gap#">
        <Formula>[Measures].[Pledges] - [Measures].[Pledges Actual Commitments]</Formula>
    </CalculatedMember>
    </VirtualCube>
</Schema>