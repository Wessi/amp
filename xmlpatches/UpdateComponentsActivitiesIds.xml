<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-5343</jira>
	<keyword>keyword</keyword>
	<author>Diego Dimunzio</author>
	<description>
		Update amp activities id for each component found in amp_activity components table 
  	</description>
	<apply>
		<script>
			<lang type="mysql" delimiter="$">	
			DROP PROCEDURE IF EXISTS patchcomponents$
			CREATE PROCEDURE patchcomponents() MODIFIES SQL DATA
			BEGIN
			DECLARE v_done INT DEFAULT 0;
			DECLARE v_activity_id, v_component_id, v_previous_component_id, v_last_inserted_component_id BIGINT(20);
			DECLARE cur1 CURSOR FOR SELECT amp_activity_id, amp_component_id from amp_activity_components order by amp_component_id;
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET v_done = 1;
			SET v_previous_component_id = -1;
			OPEN cur1;
			REPEAT
		    FETCH cur1 INTO v_activity_id, v_component_id;
		    IF NOT v_done THEN
		      IF v_previous_component_id != v_component_id THEN
		        UPDATE amp_components set amp_activity_id = v_activity_id where amp_component_id = v_component_id;
		        SET v_previous_component_id = v_component_id;
		      ELSE
		        INSERT INTO amp_components(title,description,amp_activity_id,code,`type`,creation_date)
		        SELECT title,description,v_activity_id,code,`type`,creation_date
		        FROM amp_components
		        WHERE amp_component_id = v_component_id;
		
		        SET v_last_inserted_component_id = LAST_INSERT_ID();
		
		        UPDATE amp_component_funding set amp_component_id = v_last_inserted_component_id
		        WHERE amp_component_id = v_component_id and amp_activity_id = v_activity_id;
		
		        UPDATE amp_physical_performance set amp_component_id = v_last_inserted_component_id
		        WHERE amp_component_id = v_component_id and amp_activity_id = v_activity_id;
		        END IF;
		    END IF;
		  UNTIL v_done END REPEAT;
		  CLOSE cur1;
		END$
		call patchcomponents$
		drop PROCEDURE patchcomponents$ 
			</lang>
		</script>
	</apply>
</tns:patch>
