<?xml version="1.0" encoding="UTF-8"?> 
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	
	<jira>AMP-7703</jira>
	<author>dare</author>
	<description>
		update views to use amp_activity_id column instead of activity_id
	</description>	
	
	<trigger type="all">
		<condition type="appliedPatch">dropComponentFundingFK.xml</condition>
	</trigger>
	
	<apply>		
		<script>
			<lang type="mysql" delimiter=";">
				CREATE OR REPLACE  VIEW `v_component_description` 
AS 
select distinct `a`.`amp_activity_id` AS `amp_activity_id`,`b`.`description` AS `title`,`b`.`amp_component_id` AS `amp_component_id` 
from ((`amp_activity` `a` join `amp_components` `b`) 
join `amp_component_funding` `c`) 
where ((`a`.`amp_activity_id` = `c`.`amp_activity_id`) 
and (`b`.`amp_component_id` = `c`.`amp_component_id`));  
			</lang>
		</script>
		<script>
			<lang type="mysql" delimiter=";">
				CREATE OR REPLACE VIEW `v_component_funding` AS select `f`.`amp_activity_id` AS `amp_activity_id`,`f`.`amp_component_funding_id` AS `amp_component_funding_id`,`f`.`amp_component_funding_id` AS `amp_fund_detail_id`, ct.name as `component_type`,`f`.`transaction_type` AS `transaction_type`,`f`.`adjustment_type` AS `adjustment_type`,`f`.`transaction_date` AS `transaction_date`,`f`.`transaction_amount` AS `transaction_amount`,`f`.`currency_id` AS `currency_id`,`cu`.`currency_code` AS `currency_code` from (((`amp_component_funding` `f` join `amp_components` `c`) join `amp_currency` `cu`) join `amp_component_type` ct) where ((`cu`.`amp_currency_id` = `f`.`currency_id`) and (`f`.`amp_component_id` = `c`.`amp_component_id`)) and (ct.type_id=c.type) order by `f`.`amp_activity_id`;
			</lang>
		</script>
		<script>
			<lang type="mysql" delimiter=";">
				CREATE OR REPLACE VIEW `v_components` AS select distinct `a`.`amp_activity_id` AS `amp_activity_id`,`b`.`title` AS `title`,`b`.`amp_component_id` AS `amp_component_id` from ((`amp_activity` `a` join `amp_components` `b`) join `amp_component_funding` `c`) where ((`a`.`amp_activity_id` = `c`.`amp_activity_id`) and (`b`.`amp_component_id` = `c`.`amp_component_id`));
			</lang>
		</script>
	</apply>
</tns:patch>