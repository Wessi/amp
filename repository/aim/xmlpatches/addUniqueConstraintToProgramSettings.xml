<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	
	<jira>AMP-8023</jira>
	<author>dare</author>
	<description>
		add unique constraint to amp_program_settings
	</description>	
	
	
	<apply>		
		<script>
			<lang type="mysql" delimiter=";">
				drop temporary table if exists temp_program_settings;

create temporary table temp_program_settings(
select p1.amp_program_settings_id from amp_program_settings p1 join amp_program_settings p2 on
 p1.default_hierarchy=p2.default_hierarchy group by p1.amp_program_settings_id having count(p1.amp_program_settings_id)>1 order by p1.amp_program_settings_id
);

update amp_program_settings set default_hierarchy=null where amp_program_settings_id in (select amp_program_settings_id from temp_program_settings);

alter table amp_program_settings add UNIQUE(default_hierarchy);

drop temporary table if exists temp_program_settings;
			</lang>
		</script>
	</apply>
</tns:patch>
