//>>built
define("esri/arcgis/utils","dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/has dojo/on dojo/DeferredList dojo/dom-construct esri/kernel esri/config esri/lang esri/request esri/SpatialReference esri/map esri/urlUtils esri/geometry/ScreenPoint esri/geometry/Extent esri/geometry/webMercatorUtils esri/symbols/jsonUtils esri/renderers/jsonUtils esri/dijit/PopupTemplate esri/dijit/Popup esri/tasks/query esri/tasks/GeometryService esri/arcgis/csv esri/layers/ArcGISTiledMapServiceLayer esri/layers/ArcGISDynamicMapServiceLayer esri/layers/ArcGISImageServiceLayer esri/layers/CSVLayer esri/layers/OpenStreetMapLayer esri/layers/WebTiledLayer esri/layers/FeatureLayer esri/layers/WMSLayer esri/layers/KMLLayer esri/layers/GeoRSSLayer esri/virtualearth/VETiledLayer esri/layers/TileInfo esri/layers/DynamicLayerInfo esri/layers/LayerDrawingOptions esri/layers/ImageParameters esri/layers/ImageServiceParameters esri/layers/RasterFunction esri/layers/MosaicRule esri/layers/WMSLayerInfo dojo/i18n!esri/nls/jsapi".split(" "),
function(l,g,q,r,G,ya,Ya,za,A,Aa,B,H,h,u,v,Ba,$,aa,C,Ca,P,Da,ba,Ea,Fa,Ga,ca,da,ea,fa,Ha,Ia,Ja,x,Ka,La,Ma,s,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Q){function D(a){return u({url:n.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function ga(a){var d={f:"json"};if(B.id){var c=B.id.findCredential($.urlToObject(n.arcgisUrl).path);c&&(d.token=c.token)}return u({url:a,content:d,callbackParamName:"callback"},{disableIdentityLookup:!0})}function ha(a){a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),h.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),h.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),h.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);a.itemProperties.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=a.itemProperties.popupInfo);h.isDefined(a.itemProperties.showLegend)&&!h.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);h.isDefined(a.itemProperties.refreshInterval)&&!h.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function I(a,d){var c=new r,f=a.itemData,e=[],b=[];g.forEach(f.operationalLayers,function(a){if(a.itemId&&
!a.type){var c=a.url.toLowerCase();-1<c.indexOf("/featureserver")||-1<c.indexOf("/mapserver/")?(b.push(a),e.push(D(a))):-1<c.indexOf("/mapserver")&&-1===c.indexOf("/mapserver/")&&(!a.layers||!h.isDefined(a.minScale)&&!h.isDefined(a.maxScale))?(b.push(a),e.push(D(a))):-1<c.indexOf("/imageserver")&&(!h.isDefined(a.minScale)&&!h.isDefined(a.maxScale))&&(b.push(a),e.push(D(a)))}});f.baseMap&&f.baseMap.baseMapLayers&&g.forEach(f.baseMap.baseMapLayers,function(a){a.itemId&&(b.push(a),e.push(D(a)))});0<
e.length?(new A(e)).addCallback(function(e){g.forEach(b,function(a,c){var b=e[c][1];if(b&&!a.type){var d=a.url.toLowerCase();(-1<d.indexOf("/featureserver")||-1<d.indexOf("/mapserver/"))&&b.layers?g.forEach(b.layers,function(b){if(d.endsWith("/featureserver/"+b.id)||d.endsWith("/mapserver/"+b.id))a.itemProperties=b,ha(a)}):-1<d.indexOf("/mapserver")?(b.layers&&!a.layers&&(a.layers=b.layers),h.isDefined(b.minScale)&&!h.isDefined(a.minScale)&&(a.minScale=b.minScale),h.isDefined(b.maxScale)&&!h.isDefined(a.maxScale)&&
(a.maxScale=b.maxScale),h.isDefined(b.refreshInterval)&&!h.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval)):-1<d.indexOf("/imageserver")&&(h.isDefined(b.minScale)&&!h.isDefined(a.minScale)&&(a.minScale=b.minScale),h.isDefined(b.maxScale)&&!h.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),h.isDefined(b.refreshInterval)&&!h.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),b.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=b.popupInfo),b.renderingRule&&
!a.renderingRule&&(a.renderingRule=b.renderingRule,b.renderingRule.functionName&&(a.renderingRule.rasterFunction=b.renderingRule.functionName)),b.bandIds&&!a.bandIds&&(a.bandIds=b.bandIds),b.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=b.mosaicRule),b.format&&!a.format&&(a.format=b.format),h.isDefined(b.compressionQuality)&&!h.isDefined(a.compressionQuality)&&(a.compressionQuality=b.compressionQuality))}});c.callback(a)}):c.callback(a);return c}function Va(a,d){var c=new r,f=a.itemData,e=f.baseMap.baseMapLayers[0];
if("BingMapsAerial"===e.type||"BingMapsRoad"===e.type||"BingMapsHybrid"===e.type)if(e.portalUrl)delete d.bingMapsKey,ga(e.portalUrl).then(function(b){b.bingKey?(d.bingMapsKey=b.bingKey,b=new s({bingMapsKey:d.bingMapsKey,mapStyle:s.MAP_STYLE_AERIAL}),q.connect(b,"onLoad",l.hitch(this,function(){c.callback([a,d])})),q.connect(b,"onError",function(b){delete d.bingMapsKey;a.itemData=J(f);e=a.itemData.baseMap.baseMapLayers[0];e.errors=[];e.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,d])})):(delete d.bingMapsKey,a.itemData=J(f),e=a.itemData.baseMap.baseMapLayers[0],e.errors=[],e.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),c.callback([a,d]))});else if(d.bingMapsKey){var b=new s({bingMapsKey:d.bingMapsKey,mapStyle:s.MAP_STYLE_AERIAL});q.connect(b,"onLoad",l.hitch(this,function(){c.callback([a,d])}));q.connect(b,"onError",function(b){delete d.bingMapsKey;a.itemData=J(f);e=a.itemData.baseMap.baseMapLayers[0];
e.errors=[];e.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,d])})}else a.itemData=J(f),e=a.itemData.baseMap.baseMapLayers[0],e.errors=[],e.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),c.callback([a,d]);else c.callback([a,d]);return c}function J(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?
{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},
{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function R(a,d){var c=a.dynamicLayerInfos||a.layerInfos,f=d.layers;if(f&&c){var e=[],b=[],k=[],m=[],p=[],y=[];g.forEach(c,function(c){var d=c.id;if(!c.subLayerIds&&-1!==g.indexOf(a.visibleLayers,d))for(c=0;c<f.length;c++){var w=f[c];if(w.id===d){b.push(d);e.push(w.popupInfo);k.push(w.layerUrl||"");w.layerDefinition&&
w.layerDefinition.definitionExpression?m.push(w.layerDefinition.definitionExpression):m.push("");p.push(h.isDefined(w.minScale)?w.minScale:null);y.push(h.isDefined(w.maxScale)?w.maxScale:null);break}}});e.length&&(a.__popups=e,a.__popupIds=b,a.__popupUrls=k,a.__popupWhereClauses=m,a.__popupMinScales=p,a.__popupMaxScales=y,a.__resourceInfo=d.resourceInfo)}}function S(a){if(!a)return!1;var d=(new ya(n.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(d)}function ia(a){return!a?
!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function z(a){if("https:"===location.protocol&&(S(a)||ia(a)))a=a.replace("http:","https:");return a}function T(a){var d=[];a.displayLevels||(d=g.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));d=new da(z(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||d,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});
R(d,a);return d}function U(a,d){if(!a||!d||0===d.length)return[];var c=","+d+",",f=[],e,b=",";for(e=0;e<a.length;e++)if(null!==a[e].subLayerIds){if(-1===c.indexOf(","+a[e].id+",")||-1<b.indexOf(","+a[e].id+","))b+=a[e].subLayerIds.toString()+","}else-1<c.indexOf(","+a[e].id+",")&&-1===b.indexOf(","+a[e].id+",")&&f.push(a[e].id);return f}function ja(a){var d=new Qa;d.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&
(d.format="png32");var d=new ea(z(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:d,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),c=a.visibleLayers;if(!a.visibleLayers){var f="";g.forEach(d.layerInfos,function(a){a.defaultVisibility&&(f+=(0<f.length?",":"")+a.id)});c=f}if(a.layers&&0<a.layers.length){var e=[],b=[],k,m=[],p;g.forEach(a.layers,function(c){c.layerDefinition&&c.layerDefinition.definitionExpression&&(e[c.id]=
c.layerDefinition.definitionExpression);if(c.layerDefinition&&c.layerDefinition.source){k=new Oa(l.mixin(c,c.layerDefinition));delete k.layerDefinition;k.id=c.id;if(a.visibleLayers){var d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers;-1<g.indexOf(d,c.id)?k.defaultVisibility=!0:k.defaultVisibility=!1}b.push(k)}c.layerDefinition&&(c.layerDefinition.source&&c.layerDefinition.drawingInfo)&&(p=new Pa(c.layerDefinition.drawingInfo),m[c.id]=p)},this);0<e.length&&d.setLayerDefinitions(e);
0<b.length?(d.setDynamicLayerInfos(b,!0),0<m.length&&d.setLayerDrawingOptions(m,!0)):(c=U(d.layerInfos,c),d.setVisibleLayers(c))}else c=U(d.layerInfos,c),d.setVisibleLayers(c);R(d,a);return d}function Wa(a,d){var c=new Ra;c.bandIds=a.bandIds;null!=a.format&&(c.format=a.format,null!=a.compressionQuality&&(c.compressionQuality=a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var f=new Sa(a.renderingRule);c.renderingRule=f}a.mosaicRule&&(f=new Ta(a.mosaicRule),c.mosaicRule=
f);h.isDefined(a.noData)&&(c.noData=a.noData);h.isDefined(a.noDataInterpretation)&&(c.noDataInterpretation=a.noDataInterpretation);h.isDefined(a.interpolation)&&(c.interpolation=a.interpolation);c=new fa(z(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:c,infoTemplate:a.popupInfo&&new d(a.popupInfo),minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval});a.layerDefinition&&a.layerDefinition.definitionExpression&&c.setDefinitionExpression(a.layerDefinition.definitionExpression,
!0);return c}function V(a,d,c){var f=[102113,102100,3857],e=c||new v(d[0].layerObject.fullExtent.spatialReference),b=new v(a.resourceInfo.fullExtent.spatialReference);return e.wkt==b.wkt&&(e.wkid==b.wkid||h.isDefined(e.latestWkid)&&e.latestWkid==b.wkid||h.isDefined(b.latestWkid)&&e.wkid==b.latestWkid||h.isDefined(e.latestWkid)&&e.latestWkid==b.latestWkid)||e.wkid&&b.wkid&&g.some(f,function(a){return a===b.wkid})&&g.some(f,function(a){return a===e.wkid})?!0:!1}function W(a,d){if(!d[0].layerObject.tileInfo)return!1;
var c=[];g.forEach(d,function(a){a.baseMapLayer&&a.layerObject.tileInfo&&(c=c.concat(g.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});return g.some(a.resourceInfo.tileInfo.lods,function(a){return g.some(c,function(c){return c===a.scale})})}function X(a,d,c,f,e){var b,k=c._clazz;if("OpenStreetMap"===a.type)b=new Ia({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WMS"===a.type){var m=[],p=[];g.forEach(a.layers,function(a){p.push(new Ua({name:a.name,
title:a.title,legendURL:a.legendURL}));m.push(a.name)},this);a.visibleLayers&&(m=a.visibleLayers);f={extent:new C(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new v({wkid:4326})),layerInfos:p,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0};b=new Ka(a.url,{id:a.id,visibleLayers:m,format:"png",transparent:a.baseMapLayer?!1:!0,opacity:a.opacity,
visible:null!==a.visibility?a.visibility:!0,resourceInfo:f,refreshInterval:a.refreshInterval});b.spatialReference.wkid=f.spatialReferences[0]}else if("KML"===a.type){c=a.url;if(B.id&&(k=B.id.findCredential($.urlToObject(n.arcgisUrl).path))){d=n.arcgisUrl.substring(n.arcgisUrl.indexOf("//")+2,n.arcgisUrl.indexOf("/",n.arcgisUrl.indexOf("//")+3));e=d.split(".");e=e[e.length-2]+"."+e[e.length-1];var y=c.indexOf(e);-1<y&&(c="https://"+d+c.substring(y+e.length));c+="?token\x3d"+k.token}b=new La(c,{id:a.id,
visible:null!==a.visibility?a.visibility:!0,outSR:f,refreshInterval:a.refreshInterval});q.connect(b,"onLoad",function(){(a.opacity||0===a.opacity)&&b.setOpacity(a.opacity);a.visibleFolders&&g.forEach(b.folders,function(c){-1<g.indexOf(a.visibleFolders,c.id)?b.setFolderVisibility(c,!0):b.setFolderVisibility(c,!1)},this)})}else"WebTiledLayer"===a.type?(b=new Ja(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new C(a.fullExtent),
initialExtent:a.fullExtent&&new C(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Na(a.tileInfo):null,refreshInterval:a.refreshInterval}),q.connect(b,"onLoad",function(){(h.isDefined(a.minScale)||h.isDefined(a.maxScale))&&b.setScaleRange(a.minScale,a.maxScale)})):"GeoRSS"===a.type?(b=new Ma(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:f,refreshInterval:a.refreshInterval}),q.connect(b,"onLoad",function(){!1===a.visibility&&b.hide();var c=b.getFeatureLayers();g.forEach(c,function(b){a.pointSymbol&&
"esriGeometryPoint"===b.geometryType?b.renderer.symbol=P.fromJson(a.pointSymbol):a.lineSymbol&&"esriGeometryPolyline"===b.geometryType?b.renderer.symbol=P.fromJson(a.lineSymbol):a.polygonSymbol&&"esriGeometryPolygon"===b.geometryType&&(b.renderer.symbol=P.fromJson(a.polygonSymbol));(h.isDefined(a.minScale)||h.isDefined(a.maxScale))&&b.setScaleRange(a.minScale,a.maxScale)})})):"CSV"==a.type&&a.url?(f={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,infoTemplate:new ba(a.popupInfo?
a.popupInfo:ca.generateDefaultPopupInfo(a)),id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(f.latitudeFieldName=a.locationInfo.latitudeFieldName,f.longitudeFieldName=a.locationInfo.longitudeFieldName),b=new Ha(a.url,f)):a.layerDefinition&&!a.url?(f=G.fromJson(G.toJson(a)),delete f.id,delete f.opacity,delete f.visibility,b=new x(f,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],infoTemplate:f.popupInfo&&
new k(f.popupInfo),autoGeneralize:!0})):"BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type?c.bingMapsKey?(f=s.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?f=s.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(f=s.MAP_STYLE_ROAD),b=new s({bingMapsKey:c.bingMapsKey,mapStyle:f,opacity:a.opacity,id:a.id}),q.connect(b,"onError",l.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+
a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})):a.resourceInfo&&a.resourceInfo.mapName?b=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||V(a,d,f)&&W(a,e))?T(a):ja(a):a.resourceInfo&&a.resourceInfo.pixelSizeX?b=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||V(a,d,f)&&W(a,e))?T(a):Wa(a,k):a.resourceInfo&&"Feature Layer"===a.resourceInfo.type&&(a.capabilities&&
(a.resourceInfo.capabilities=a.capabilities),b=new x(z(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:S(a.url)?x.MODE_AUTO:h.isDefined(a.mode)?a.mode:x.MODE_ONDEMAND,outFields:["*"],infoTemplate:a.popupInfo&&new k(a.popupInfo),autoGeneralize:!0,refreshInterval:a.refreshInterval}),a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(f=Da.fromJson(a.layerDefinition.drawingInfo.renderer),f.isMaxInclusive=!0,b.setRenderer(f)),
a.layerDefinition.definitionExpression&&b.setDefinitionExpression(a.layerDefinition.definitionExpression),h.isDefined(a.layerDefinition.minScale)&&b.setMinScale(a.layerDefinition.minScale),h.isDefined(a.layerDefinition.maxScale)&&b.setMaxScale(a.layerDefinition.maxScale)));b&&(b.arcgisProps={title:a.title},a.baseMapLayer&&(b._basemapGalleryLayerType=a.isReference?"reference":"basemap"));return b}function Y(a,d,c,f){g.forEach(a,function(b,e){if(b.url&&!b.type){if(0===e||a[0].layerObject)b.layerObject=
X(b,a,d,c,f)}else b.layerObject=X(b,a,d,c,f)});var e=g.filter(a,function(a){return!a.isReference}),b=g.filter(a,function(a){return!!a.isReference});return a=e.concat(b)}function Z(a){var d=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(d=new v,a.resourceInfo.spatialReference.wkid&&(d.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(d.wkt=a.resourceInfo.spatialReference.wkt)):-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?d=new v({wkid:102100}):
"WMS"==a.type&&(d=new v({wkid:a.spatialReferences[0]}));return d}function ka(a,d,c,f,e,b,k){g.forEach(d,function(b,c){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});b=b||Z(d);d=Y(d,c,b,k);e.callback(d);return e}function la(a,d){var c=z(a);return u({url:c,content:{f:"json"},callbackParamName:"callback",error:function(a,e){a.message=a.message?a.message+(" [url:"+c+"]"):"[url:"+c+"]";d.push(a);H.defaults.io.errorHandler(a,e)}})}function ma(a){var d=n.arcgisUrl+"/"+a.itemId+
"/data";return u({url:d,content:{f:"json"},callbackParamName:"callback",error:function(c,f){c.message=c.message?c.message+(" [url:"+d+"]"):"[url:"+d+"]";a.errors=a.errors||[];a.errors.push(c);H.defaults.io.errorHandler(c,f)}})}function na(a,d,c){var f=new r;if((!c.featureCollection||!c.featureCollection.layers)&&!c.layers)return a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),f.errback(),f;c.layers&&(c.featureCollection={layers:c.layers},
delete c.layers,h.isDefined(c.showLegend)&&(c.featureCollection.showLegend=c.showLegend,delete c.showLegend));oa(a,c.featureCollection,d).then(function(d){c.featureCollection=d;a.featureCollection&&a.featureCollection.layers?g.forEach(c.featureCollection.layers,function(b,c){var d=a.featureCollection.layers[c];if(!d.poupInfo&&!d.layerDefinition)d.popupInfo=b.popupInfo,d.layerDefinition=b.layerDefinition;else if(d.layerDefinition){if(h.isDefined(d.layerDefinition.minScale)&&h.isDefined(d.layerDefinition.maxScale)&&
(d.layerDefinition.minScale!==b.layerDefinition.minScale||d.layerDefinition.maxScale!==b.layerDefinition.maxScale))delete b.layerDefinition.minscale,delete b.layerDefinition.maxScale;d.layerDefinition.drawingInfo&&G.toJson(d.layerDefinition.drawingInfo)!==G.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo;d.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend;d.layerDefinition=l.mixin(d.layerDefinition,b.layerDefinition)}else d.layerDefinition=
b.layerDefinition;d.featureSet=b.featureSet;d.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=l.mixin(a.featureCollection,c.featureCollection));f.callback(a)});return f}function oa(a,d,c){var f=new r,e=[];g.forEach(d.layers,function(a){a.featureSet&&(a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)&&(a.deferredsPos=e.length,e.push(ca.projectFeatureCollection(a,
c,a.featureSet.features[0].geometry.spatialReference)))});(new A(e)).addCallback(function(){g.forEach(d.layers,function(b){h.isDefined(b.deferredsPos)&&(e[b.deferredsPos].results&&e[b.deferredsPos].results.length?b=e[b.deferredsPos].results[0]:(b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});f.callback(d)});return f}function K(a,d,c,f){var e=new r,b=new r,k=[],m;g.forEach(a.operationalLayers,
function(a,b){a.itemId&&"Feature Collection"==a.type&&k.push(ma(a).then(l.hitch(null,na,a,c)))});0===k.length?pa(a,d,c,f,b):(m=new A(k),m.addCallback(function(e){pa(a,d,c,f,b)}));b.then(function(a){k=[];g.forEach(a,function(a){a=a.layerObject;if(a instanceof x&&!a.loaded&&!a.loadError){var b=new r;za.once(a,"load, error",function(){b.callback(a)});k.push(b)}});0===k.length?e.callback(a):(m=new A(k),m.addCallback(function(){e.callback(a)}))});return e}function pa(a,d,c,f,e){var b=[],k=[],m=[];g.forEach(a.operationalLayers,
function(a,b){a.featureCollection?g.forEach(a.featureCollection.layers,function(c,d){var e=!0;a.visibleLayers&&-1==g.indexOf(a.visibleLayers,d)&&(e=!1);c.visibility=a.visibility&&e;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+d;m.push(c)},this):m.push(a)});g.forEach(a.baseMap.baseMapLayers,function(a,c){a.baseMapLayer=!0;a.id=a.id||"base"+c;b.push(a)});g.forEach(m,function(a,c){a.id=a.id||"operational"+c;b.push(a)});g.forEach(b,function(a){a.url&&!a.type&&(a.deferredsPos=k.length,a.errors=
a.errors||[],k.push(la(a.url,a.errors)))});0===k.length?(c=c||Z(b),b=Y(b,d,c,f),e.callback(b)):(new A(k)).addCallback(function(a){ka(a,b,d,k,e,c,f)});return e}function L(a,d,c,f){var e=a.minScale,b=a.maxScale;if(10.1>=c.version&&d)for(a=d.length-1;0<=a;a--){if(d[a].id==f)if(0==e&&0<d[a].minScale?e=d[a].minScale:0<e&&0==d[a].minScale?e=c.minScale:0<e&&0<d[a].minScale&&(e=Math.min(e,d[a].minScale)),b=Math.max(c.maxScale||0,d[a].maxScale||0),c.setScaleRange(e,b),-1<d[a].parentLayerId)f=d[a].parentLayerId;
else break}else 10.1<c.version&&(g.forEach(a.layerInfos,function(a){a.id==f&&(0==e&&0<a.minScale?e=a.minScale:0<e&&0==a.minScale||0<e&&0<a.minScale&&(e=Math.min(e,a.minScale)),b=Math.max(b||0,a.maxScale||0))}),c.setScaleRange(e,b))}function M(a,d,c,f){var e=a.url,b=a.__popupIds,k=a.__popupUrls,m=a.__popupWhereClauses,p=a.__popupMinScales,y=a.__popupMaxScales,E=a.__resourceInfo,F=[];g.forEach(a.__popups,function(f,l){if(f){var n,r=[];g.forEach(f.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&
r.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var s=g.filter(a.dynamicLayerInfos,function(a){return b[l]==a.id})[0].source;n=new x(e+"/dynamicLayer",{id:a.id+"_"+b[l],source:s,outFields:r,mode:x.MODE_SELECTION,infoTemplate:f&&new c(f),drawMode:!1,visible:a.visible,autoGeneralize:!0});var t=function(c,e){0<m[c].length&&e.setDefinitionExpression(m[c]);if(!h.isDefined(p[c])&&!h.isDefined(y[c]))L(a,d||E.layers,e,b[c]);else if(h.isDefined(a.minScale)||h.isDefined(a.maxScale)){var f=
a.minScale,k=a.maxScale;0==f&&0<p[c]?f=p[c]:0<f&&0==p[c]||0<f&&0<p[c]&&(f=Math.min(f,p[c]));k=Math.max(k||0,y[c]||0);e.setScaleRange(f,k)}else e.setScaleRange(p[c],y[c])};n.loaded?t(l,n):q.connect(n,"onLoad",function(a){t(l,n)})}else{var u=null,v=e+"/"+b[l];if(k[l].length)v=k[l];else if(d)for(s=0;s<d.length;s++)if(d[s].id===b[l]){u=d[s];break}n=new x(z(v),{id:a.id+"_"+b[l],outFields:r,mode:x.MODE_SELECTION,infoTemplate:f&&new c(f),drawMode:!1,visible:a.visible,resourceInfo:u,autoGeneralize:!0});n.loaded?
(0<m[l].length&&n.setDefinitionExpression(m[l]),L(a,d||E.layers,n,b[l])):q.connect(n,"onLoad",function(c){0<m[l].length&&n.setDefinitionExpression(m[l]);L(a,d||E.layers,c,b[l])})}F.push(n)}});0<F.length&&(q.connect(a,"onVisibilityChange",l.hitch(this,function(a,c){g.forEach(a,function(a){c?a.show():a.hide()})},F)),q.connect(f,"onLayerRemove",l.hitch(this,function(a,c,b){a.id===b.id&&g.forEach(c,function(a){f.removeLayer(a)})},a,F)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;
delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return F}function qa(a){return u({url:z(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function ra(a,d,c){var f=[];g.forEach(a,function(a){var c=a.__popups;c&&(1<c.length&&10<=a.version)&&(a.__deferredsPos=f.length,f.push(qa(a)))});var e=[];0<f.length?(new A(f)).addCallback(function(b){g.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(e=
e.concat(M(a,b[a.__deferredsPos][1].layers,c,d)),delete a.__deferredsPos):e=e.concat(M(a,null,c,d)))});d.addLayers(e)}):(g.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(e=e.concat(M(a,null,c,d)))}),d.addLayers(e))}function sa(a){g.forEach(a,function(a){var c=a.layer;c.toJson&&(a=c.toJson(),a.featureSet&&-1<c.name.indexOf("Text")&&g.forEach(a.featureSet.features,function(a,d){if(a.attributes.TEXT){var b=c.graphics[d];b.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(b.symbol.align=
a.symbol.horizontalAlignment);b.setSymbol(b.symbol);b.setAttributes(a.attributes)}},this))})}function ta(a){var d=6;g.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(d=Math.max(d,Math.abs(a.xoffset))),a&&a.yoffset&&(d=Math.max(d,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&g.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(d=Math.max(d,Math.abs(a.xoffset)));
a&&a.yoffset&&(d=Math.max(d,Math.abs(a.yoffset)))})});return d}function N(a){var d=this,c=d.infoWindow,f=a.graphic;if(d.loaded){c.hide();c.clearFeatures();var e=[];g.forEach(d.graphicsLayerIds,function(a){if((a=d.getLayer(a))&&-1!==a.declaredClass.indexOf("FeatureLayer")&&a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&e.push(a)});g.forEach(d.layerIds,function(a){(a=d.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&
e.push(a)});f=f&&f.getInfoTemplate()?f:null;if(e.length||f){var b=ta(e),k=a.screenPoint,m=d.toMap(new aa(k.x-b,k.y+b)),b=d.toMap(new aa(k.x+b,k.y-b)),m=new C(m.x,m.y,b.x,b.y,d.spatialReference),h=new Fa;h.geometry=m;h.timeExtent=d.timeExtent;var l=!0,m=g.map(e,function(a){var c;-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?(l=!1,c=a.queryVisibleRasters(h,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return a.getVisibleRasters()})):(c=a.selectFeatures(h),
c.addCallback(function(){return a.getSelectedFeatures()}));return c});f&&(b=new r,b.callback([f]),m.splice(0,0,b));if(!g.some(m,function(a){return-1===a.fired})){var n=f?1:0;g.forEach(e,function(a){n=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?n+a.getVisibleRasters().length:n+a.getSelectedFeatures().length});if(!n)return}c.setFeatures(m);c.show(a.mapPoint,{closestFirst:l})}}}function Xa(a,d){var c=d.mapOptions||{},f;c.infoWindow||(f=new Ea({visibleWhenEmpty:!1},Aa.create("div")),c.infoWindow=
f);h.isDefined(c.showInfoWindowOnClick)||(c.showInfoWindowOnClick=!1);c=new Ba(a,c);q.connect(c,"onLayersAddResult",sa);return c}function t(a,d,c,f,e,b){var k,h,p;f.map?(k=f.map,h=f.clickEventHandle,p=f.errors):(k=Xa(f,e),!e.ignorePopups&&!e.disableClickBehavior&&(h=q.connect(k,"onClick",N)));e.ignorePopups&&g.forEach(a,function(a){delete a.infoTemplate});k.addLayers(a);e.ignorePopups||ra(a,k,e._clazz);var l=p||[];g.forEach(d,function(a){a.errors&&(l=l.concat(a.errors))},this);k.loaded?b.callback({map:k,
itemInfo:c,errors:l,clickEventHandle:h,clickEventListener:N}):q.connect(k,"onLoad",function(){b.callback({map:k,itemInfo:c,errors:l,clickEventHandle:h,clickEventListener:N})})}function O(a,d,c,f,e){var b=[];g.forEach(e,function(a){l.isArray(a.layerObject)?g.forEach(a.layerObject,function(a){b.push(a)}):b.push(a.layerObject)});if("BingMapsAerial"===e[0].type||"BingMapsRoad"===e[0].type||"BingMapsHybrid"===e[0].type)var k=setInterval(function(){if(e[0].layerObject&&e[0].layerObject.loaded)clearInterval(k),
ua(a,d,c,f,e,b);else if(e[0].errors){clearInterval(k);var g="";e[0].errors&&e[0].errors.length&&(g=" ("+e[0].errors[0].message+")");f.errback(Error(Q.arcgis.utils.baseLayerError+g))}},10);else if(!b[0]&&e[0].baseMapLayer){var h="";e[0].errors&&e[0].errors.length&&(h=" ("+e[0].errors[0].message+")");f.errback(Error(Q.arcgis.utils.baseLayerError+h))}else ua(a,d,c,f,e,b)}function ua(a,d,c,f,e,b){try{var k=c.mapOptions||{};c.mapOptions=k;var m=a.item;b=g.filter(b,h.isDefined);if(m)if(m.extent&&m.extent.length)if(k.extent)t(b,
e,a,d,c,f);else{var l=new C(m.extent[0][0],m.extent[0][1],m.extent[1][0],m.extent[1][1],new v({wkid:4326})),n=b[0].spatialReference;4326===n.wkid?(k.extent=l,t(b,e,a,d,c,f)):102100===n.wkid||102113===n.wkid||3857===n.wkid?(l.xmin=Math.max(l.xmin,-180),l.xmax=Math.min(l.xmax,180),l.ymin=Math.max(l.ymin,-89.99),l.ymax=Math.min(l.ymax,89.99),k.extent=Ca.geographicToWebMercator(l),t(b,e,a,d,c,f)):c.geometryServiceURL||H.defaults.geometryService?(c.geometryServiceURL?new Ga(c.geometryServiceURL):H.defaults.geometryService).project([l],
n,function(g){g=g[0];k.extent=k.extent||g;t(b,e,a,d,c,f)},function(){t(b,e,a,d,c,f)}):f.errback(Error(Q.arcgis.utils.geometryServiceError))}else t(b,e,a,d,c,f);else t(b,e,a,d,c,f)}catch(E){f.errback(E)}}function va(a){var d=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);g.forEach(a,function(a,f){var e={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&g.forEach(a.featureCollection.layers,function(b){!1!==b.showLegend&&(e={layer:b.layerObject,title:a.title,defaultSymbol:b.renderer&&
b.renderer.defaultSymbol&&b.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(e.title+=" - "+b.layerDefinition.name),d.push(e))});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var b=a.layerObject.renderer,b=!b||b&&b.defaultSymbol&&b.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&(a.layerObject instanceof ea||a.layerObject instanceof da)||a.layerObject instanceof fa)b=!0;e={layer:a.layerObject,title:a.title,defaultSymbol:b};
a.layers&&(b=g.map(g.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),b.length&&(e.hideLayers=b));d.push(e)}});return d}function wa(a,d,c,f){Va(f,d).then(function(d){var b=d[0],f=d[1];if(!b.itemData.operationalLayers||0===b.itemData.operationalLayers.length)I(b,f).addCallback(function(b){K(b.itemData,f).addCallback(l.hitch(null,O,b,a,f,c))});else{var h=new r,n=b.itemData.baseMap.baseMapLayers.slice(0),q=g.filter(b.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});
d={item:b.item,itemData:{baseMap:{baseMapLayers:q}}};b.itemData.baseMap.baseMapLayers=g.filter(b.itemData.baseMap.baseMapLayers,function(a){return a.isReference});I(d,f).addCallback(function(b){K(b.itemData,f).addCallback(l.hitch(null,O,b,a,f,h))});h.then(function(a){I(b,f).addCallback(function(b){K(b.itemData,f,a.map.spatialReference,q).addCallback(function(d){b.itemData.baseMap.baseMapLayers=n;O(b,a,f,c,d)})})},l.hitch(c,c.errback))}})}function xa(a){n._arcgisUrl&&0<n._arcgisUrl.length&&(n.arcgisUrl=
n._arcgisUrl);var d=n.arcgisUrl+"/"+a,c={},f=new r;u({url:d,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;u({url:d+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;f.callback(c)},error:function(a){f.errback(a)}})},error:function(a){f.errback(a)}});return f}String.prototype.endsWith=function(a){return this.match(a+"$")==a};var n;n={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:xa,createMap:function(a,
d,c){var f=new r;c=c||{};var e=c.infoTemplateClass;c._clazz=e&&(l.isObject(e)?e:l.getObject(e))||ba;l.isString(a)?xa(a).addCallback(l.hitch(null,wa,d,c,f)).addErrback(l.hitch(f,f.errback)):wa(d,c,f,a);return f},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?va(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:I,_getItemData:D,_getBingKey:ga,_processFSItemProperties:ha,_getLayers:K,_preBuildLayerObjects:ka,_buildLayerObjects:Y,_preCreateMap:O,_getMapSR:Z,_createMap:t,_addSelectionLayers:ra,
_createSelectionFeatureLayers:M,_getServiceInfo:la,_getFeatureCollectionItem:ma,_mergeFeatureCollectionItem:na,_projectFeatureCollection:oa,_getLayersInfo:qa,_initLayer:X,_loadAsCached:T,_loadAsDynamic:ja,_processPopups:R,_onLayersAddResult:sa,_sameSpatialReferenceAsBasemap:V,_sameTilingSchemeAsBasemap:W,_showPopup:N,_calculateClickTolerance:ta,_getVisibleFeatureLayers:U,_updateLayerScaleInfo:L,_checkUrl:z,_isHostedService:S,_isAgolService:ia,_getLegendLayers:va};l.setObject("arcgis.utils",n,B);return n});
//@ sourceMappingURL=utils.js.map