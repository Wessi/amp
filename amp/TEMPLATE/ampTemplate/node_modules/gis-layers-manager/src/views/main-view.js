var fs = require('fs');
var $ = require('jquery');
var _ = require('underscore');
var Backbone = require('backbone');
var Translator = require('amp-translate');
var Wizard = require('./wizard');
var Admin = require('./admin');
var Translator = require('amp-translate');

var Template = fs.readFileSync(__dirname + '/../templates/main-view.html', 'utf8');
module.exports = Backbone.View.extend({
	id: 'layer-manager',
	events: {  
		'click .cancel': 'cancel'
	},
	template: _.template(Template),  
	initialize:function(options) {
		this.draggable = options.draggable;
		this.caller = options.caller;
		if(options.translator === undefined) {
			this.createTranslator();
		} else {
			this.translator = options.translator;
		}
		this.wizard = new Wizard({translate: this.translate});
		this.admin = new Admin({translate: this.translate});
	},  
	render: function() {
		var self = this;
		this.$el.addClass('panel panel-primary');
		if (this.draggable) {
			this.$el.draggable({ cancel: '.panel-body, .panel-footer', cursor: 'move', containment: 'window' });
		}
		this.$el.html(this.template({}));
		this.$el.show();
		this.$el.find("#wizard").empty();
		this.$el.find("#admin").empty();
		this.$el.find("#wizard").append(this.wizard.render().el);
		this.$el.find("#admin").append(this.admin.render().el);
		self.translate(this.$el);
		return this;
	},
	createTranslator: function(force) {
		var self = this;
		var translateKeys = JSON.parse(fs.readFileSync(__dirname + '/../lib/initial-translation-request.json', 'utf8'));
		// setup any popovers as needed...
		//self.popovers = self.$('[data-toggle="popover"]');
		//self.popovers.popover();
		if (force === true || self.translator === undefined) {	      
			self.translator = new Translator({defaultKeys: translateKeys});
		}
	},
	translate: function(target) {
		var element = this;
		if (target !== undefined) {
			element = target;
		}
		if (element.el !== undefined) {
			this.translator.translateDOM(element.el);
		} else {
			this.translator.translateDOM(element);
		}
	},
	show: function(){
		this.render();
	},
	cancel: function(){
		this.trigger('cancel');
	}
});