<?xml version="1.0"?>
<!DOCTYPE AMP [
<!ENTITY mondriandtd SYSTEM "mondrian.dtd">]>
<Schema name="AMP">
	<Dimension name="Activity">
		<Hierarchy hasAll="true" primaryKey="amp_activity_id" primaryKeyTable="cached_amp_activity" allMemberCaption="All_Activities" allMemberName="All Activities" caption="Activity">
			<!-- Limit the activities showed to those belonging to the workspace selected  -->
			<Table name="cached_amp_activity"/>
			<Level name="Activity Title" column="name" table="cached_amp_activity" uniqueMembers="true" />
			<Level name="AMP ID" column="amp_id" table="cached_amp_activity" uniqueMembers="true" />
		</Hierarchy>
	</Dimension>
	<Dimension name="Donor Group"> 
			<Hierarchy hasAll="true" allLevelName="All Donor Group" caption="Donor_Group" allMemberCaption="All_Donor_Group" primaryKey="amp_activity_id" primaryKeyTable="cached_v_donor_groups">
				<Table name="cached_v_donor_groups"/>
				<Level name="DonorGroup" column="name">
					<NameExpression>
						<SQL dialect="generic">
							COALESCE(cached_v_donor_groups.name,'No_Data')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
	<Dimension name="Donor Dates" type="TimeDimension">
		<Hierarchy hasAll="true" allMemberName="All Periods" allMemberCaption="All_Donor_Dates" primaryKey="amp_fund_detail_id" caption="Donor_Dates">
			<Table name="cached_v_donor_date_hierarchy" />
				<Level name="Year" column="year" levelType="TimeYears" type="Numeric" />
				<Level name="Quarter" column="quarter_name" ordinalColumn="quarter" nameColumn="quarter_name" levelType="TimeQuarters" type="Numeric" />
				<Level name="Month" column="month_name" uniqueMembers="false" ordinalColumn="month" nameColumn="month_name" levelType="TimeMonths" type="Numeric">
				<NameExpression>
					<SQL dialect="generic">
						case WHEN cached_v_donor_date_hierarchy.month_name= 'january' THEN 'january'
						WHEN month_name='february' THEN 'february' 
						WHEN month_name='march' THEN 'march'
						WHEN month_name='april' THEN 'april'
						WHEN month_name='may' THEN 'may'
						WHEN month_name='june' THEN 'june'
						WHEN month_name='july' THEN 'july'
						WHEN month_name='august' THEN 'august'
						WHEN month_name='september' THEN 'september'
						WHEN month_name='october' THEN 'october'
						WHEN month_name='november' THEN 'november'
						WHEN month_name='december' THEN 'december'
						END
					</SQL>
				</NameExpression>
				</Level>
				
		</Hierarchy>
	</Dimension>
	<Dimension name="Status">
		<Hierarchy hasAll="true" allMemberCaption="All_Status" allMemberName="All Status" primaryKey="amp_activity_id" caption="Status">
			<Table name="cached_v_status" />
			<Level name="Status" column="name" table="cached_v_status" />
		</Hierarchy>
	</Dimension>
	<Dimension name="Donor Types" >
			<Hierarchy hasAll="true" allLevelName="All Donors types" caption="Donors_types" allMemberCaption="All_Donors_types" primaryKey="amp_activity_id">
				<Table name="cached_v_donor_type" />
				<Level name="DonorType" column="org_type">
				<NameExpression>
						<SQL dialect="generic">
							COALESCE(org_type,'No_Data')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
	</Dimension>
	<Dimension name="Primary Sector">
			<Hierarchy hasAll="true" allMemberCaption="All_Primary_Sectors" allMemberName="All Primary Sectors" primaryKey="amp_activity_id" caption="Primary_Sector">
			<table name="cached_v_sectors"/>
				<Level name="Primary Sector" column="sectorname">
				<NameExpression>
						<SQL dialect="generic">
							COALESCE(sectorname,'No_Data')
						</SQL>
					</NameExpression>
				</Level>
			</Hierarchy>
		</Dimension>
	
	<Cube name="Donor Funding">
		<Table name="cached_v_donor_funding"/>
		<DimensionUsage name="Activity" source="Activity" foreignKey="amp_activity_id" />
		<DimensionUsage name="Donor Dates" source="Donor Dates" foreignKey="amp_activity_id" />
		<DimensionUsage name="Status" source="Status" foreignKey="amp_activity_id" />
		<DimensionUsage name="Donor Group" source="Donor Group" foreignKey="amp_activity_id" />
		<DimensionUsage name="Donor Types" source="Donor Types" foreignKey="amp_activity_id" />
		<DimensionUsage name="Primary Sector" source="Primary Sector" foreignKey="amp_activity_id" />
		<Measure name="Actual Commitments" aggregator="sum">
			<MeasureExpression>
				<SQL dialect="generic" aggregator="sum">
					case when cached_v_donor_funding.transaction_type=0
					and cached_v_donor_funding.adjustment_type=272 then
					cached_v_donor_funding.transaction_amount * getExchange('USD',cached_v_donor_funding.transaction_date)
					else 0 end
					
				</SQL>
			</MeasureExpression>
		</Measure>
		<Measure name="Actual Disbursement" aggregator="sum">
			<MeasureExpression>
				<SQL dialect="generic">
					(case when cached_v_donor_funding.transaction_type=1 
					and cached_v_donor_funding.adjustment_type=272 then
						cached_v_donor_funding.transaction_amount
					else 0 end)
				</SQL>
			</MeasureExpression>
		</Measure>
		
	</Cube>
 </Schema>