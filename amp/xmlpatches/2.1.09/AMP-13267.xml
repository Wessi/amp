<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="false" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-13267</jira>
  <keyword>Pledges Reports</keyword>
  <author>Diego</author> 

  <apply>
    <script>
      <lang delimiter=";" type="postgres">
		DROP VIEW v_pledges_funding_st;
		CREATE OR REPLACE VIEW v_pledges_funding_st AS 
		select 
		    f.id AS pledge_id,
		    d.name AS donor_name,
		    fd.id AS amp_fund_detail_id,
		    afd.transaction_type AS transaction_type,
		    afd.adjustment_type AS adjustment_type,
		    cval3.category_value AS adjustment_type_name,
		    afd.transaction_date AS transaction_date,
		    afd.transaction_amount AS transaction_amount,
		    c.currency_code AS currency_code,
		    cval.id AS terms_assist_id,
		    cval.category_value AS terms_assist_name,
		    b.org_grp_name AS org_grp_name,
		    ot.org_type AS donor_type_name,
		    cval2.category_value AS financing_instrument_name,
		    cval2.id AS financing_instrument_id,
		    d.amp_org_id AS org_id,
		    d.org_grp_id AS org_grp_id,
		    ot.amp_org_type_id AS org_type_id 
		  from 
		    amp_funding_pledges f 
		    join amp_funding_pledges_details fd on f.id = fd.pledge_id
		    left join amp_category_value cval on cval.id = fd.type_of_assistance 
		    left join amp_currency c on c.amp_currency_id = fd.currency
		    join amp_organisation d on d.amp_org_id = f.amp_org_id
		    left join amp_org_group b on b.amp_org_grp_id = d.org_grp_id
		    left join amp_org_type ot  on ot.org_type_code = d.org_type_code
		    left join amp_category_value cval2 on cval2.id = fd.aid_modality 
		    join amp_funding_detail afd on afd.pledge_id = f.id 
		    left join amp_category_value cval3 on cval3.id = afd.adjustment_type
		
		union all
		select 
		    f.id AS pledge_id,
		    d.name AS donor_name,
		    fd.id AS amp_fund_detail_id,
		    7 AS transaction_type,
		    1 AS adjustment_type,
		    cval3.category_value AS adjustment_type_name,
		    to_date('02 Jan '::text || fd.year::text, 'DD Mon YYYY'::text) AS transaction_date,
		    fd.amount AS transaction_amount,
		    c.currency_code AS currency_code,
		    cval.id AS terms_assist_id,
		    cval.category_value AS terms_assist_name,
		    b.org_grp_name AS org_grp_name,
		    ot.org_type AS donor_type_name,
		    cval2.category_value AS financing_instrument_name,
		    cval2.id AS financing_instrument_id,
		    d.amp_org_id AS org_id,
		    d.org_grp_id AS org_grp_id,
		    ot.amp_org_type_id AS org_type_id 
		  from 
		  amp_funding_pledges f 
		    join amp_funding_pledges_details fd on f.id = fd.pledge_id
		    left join amp_category_value cval on cval.id = fd.type_of_assistance 
		    left join amp_currency c on c.amp_currency_id = fd.currency
		    join amp_organisation d on d.amp_org_id = f.amp_org_id
		    left join amp_org_group b on b.amp_org_grp_id = d.org_grp_id
		    left join amp_org_type ot  on ot.org_type_code = d.org_type_code
		    left join amp_category_value cval2 on cval2.id = fd.aid_modality 
		    join amp_funding_detail afd on afd.pledge_id = f.id 
		    left join amp_category_value cval3 on cval3.id = afd.adjustment_type

    
      </lang>
    </script>
  </apply>
</tns:patch>