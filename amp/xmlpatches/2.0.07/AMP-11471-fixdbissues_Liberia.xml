<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-11471</jira>
	<keyword>amp_activity</keyword>
	<keyword>invalid</keyword>
	<keyword>projects</keyword>
	<author>Fernando Ferreyra</author>
	<description>This fixes the amp_activity view for Liberia as well as activities with amp_team_id set to null (with ids higher that the last migrated id (314), meaning just the test versions)</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="db">
				<lang type="postgres">SELECT current_database()</lang>
			</script>
			<test>db.equalsIgnoreCase("amp_liberia") || db.equalsIgnoreCase("amp_liberia")</test>
		</condition>
	</trigger>
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
delete from amp_funding_detail where amp_fund_detail_id in (select afd.amp_fund_detail_id from  amp_funding_detail afd, amp_funding af, amp_activity_version aav where af.amp_activity_id = aav.amp_activity_id AND afd.amp_funding_id = af.amp_funding_id AND aav.amp_team_id is null and aav.amp_activity_id > 314);
delete from amp_funding where amp_funding_id in (select af.amp_funding_id from amp_funding af, amp_activity_version aav where af.amp_activity_id = aav.amp_activity_id AND aav.amp_team_id is null and aav.amp_activity_id > 314);
delete from amp_activity_location where amp_activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
delete from amp_activity_sector where amp_activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
delete from amp_activities_categoryvalues where amp_activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
delete from amp_indicator_values where ind_connect_id in (select id from amp_indicator_connection where activity_id in 	(select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314));
delete from amp_indicator_connection where activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
delete from amp_activity_program where amp_activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
delete from amp_org_role where activity in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
delete from amp_ahsurvey_response where amp_ahsurvey_id in (select amp_ahsurvey_id from amp_ahsurvey where amp_activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314));
delete from amp_ahsurvey where amp_activity_id in (select amp_activity_id from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314);
update amp_activity_group set amp_activity_last_version_id = null WHERE amp_activity_group.amp_activity_last_version_id in (select amp_activity_id from amp_activity_version where amp_team_id is null and amp_activity_id > 314);
update amp_activity_version set amp_activity_group_id = null where amp_team_id is null and amp_activity_id > 314;
delete from amp_activity_group where amp_activity_last_version_id is null;
delete from amp_activity_version WHERE amp_team_id is null and amp_activity_id > 314;

			
CREATE OR REPLACE VIEW amp_activity (
    amp_activity_id,
    amp_id,
    name,
    gov_agreement_number,
    budget_code_project_id,
    description,
    lessons_learned,
    objectives,
    results,
    purpose,
    projectcomments,
    project_impact,
    activity_summary,
    contracting_arrangements,
    cond_seq,
    linked_activities,
    conditionality,
    project_management,
    contract_details,
    activity_level_id,
    document_space,
    "language",
    budget,
    version,
    equalopportunity,
    environment,
    minorities,
    draft,
    created_as_draft,
    cal_type,
    activity_approval_date,
    activity_start_date,
    activity_close_date,
    original_comp_date,
    contracting_date,
    disbursments_date,
    condition_,
    contact_name,
    comments,
    status_reason,
    proposed_start_date,
    actual_start_date,
    proposed_approval_date,
    actual_approval_date,
    actual_completion_date,
    proposed_completion_date,
    date_created,
    date_updated,
    updated_by,
    program_description,
    contractors,
    proj_cost_amount,
    proj_cost_date,
    proj_cost_currcode,
    convenio_date_filter,
    convenio_numcont,
    classi_code,
    fy,
    vote,
    subvote,
    subprogram,
    project_code,
    cris_number,
    gbssbs,
    governmentapprovalprocedures,
    jointcriteria,
    humanitarianaid,
    amp_theme_id,
    amp_categ_val_modality_id,
    amp_team_id,
    author,
    activity_creator,
    approval_status,
    line_min_rank,
    plan_min_rank,
    customfield1,
    customfield2,
    customfield3,
    customfield4,
    customfield5,
    customfield6,
    approvedby,
    approvaldate,
    chapter_code,
    budget_sector,
    budget_organization,
    budget_department,
    budget_program,
    amp_activity_group_id,
    amp_activity_previous_version_id,
    modified_date,
    modified_by,
    iati_last_update_date,
    deleted,
    merged_activity,
    merge_source1,
    merge_source2)
AS
SELECT amp_activity_version.amp_activity_id, amp_activity_version.amp_id,
    amp_activity_version.name, amp_activity_version.gov_agreement_number,
    amp_activity_version.budget_code_project_id,
    amp_activity_version.description, amp_activity_version.lessons_learned,
    amp_activity_version.objectives, amp_activity_version.results,
    amp_activity_version.purpose, amp_activity_version.projectcomments,
    amp_activity_version.project_impact, amp_activity_version.activity_summary,
    amp_activity_version.contracting_arrangements,
    amp_activity_version.cond_seq, amp_activity_version.linked_activities,
    amp_activity_version.conditionality,
    amp_activity_version.project_management,
    amp_activity_version.contract_details,
    amp_activity_version.activity_level_id,
    amp_activity_version.document_space, amp_activity_version.language,
    amp_activity_version.budget, amp_activity_version.version,
    amp_activity_version.equalopportunity, amp_activity_version.environment,
    amp_activity_version.minorities, amp_activity_version.draft,
    amp_activity_version.created_as_draft, amp_activity_version.cal_type,
    amp_activity_version.activity_approval_date,
    amp_activity_version.activity_start_date,
    amp_activity_version.activity_close_date,
    amp_activity_version.original_comp_date,
    amp_activity_version.contracting_date,
    amp_activity_version.disbursments_date, amp_activity_version.condition_,
    amp_activity_version.contact_name, amp_activity_version.comments,
    amp_activity_version.status_reason,
    amp_activity_version.proposed_start_date,
    amp_activity_version.actual_start_date,
    amp_activity_version.proposed_approval_date,
    amp_activity_version.actual_approval_date,
    amp_activity_version.actual_completion_date,
    amp_activity_version.proposed_completion_date,
    amp_activity_version.date_created, amp_activity_version.date_updated,
    amp_activity_version.updated_by, amp_activity_version.program_description,
    amp_activity_version.contractors, amp_activity_version.proj_cost_amount,
    amp_activity_version.proj_cost_date,
    amp_activity_version.proj_cost_currcode,
    amp_activity_version.convenio_date_filter,
    amp_activity_version.convenio_numcont, amp_activity_version.classi_code,
    amp_activity_version.fy, amp_activity_version.vote,
    amp_activity_version.subvote, amp_activity_version.subprogram,
    amp_activity_version.project_code, amp_activity_version.cris_number,
    amp_activity_version.gbssbs,
    amp_activity_version.governmentapprovalprocedures,
    amp_activity_version.jointcriteria, amp_activity_version.humanitarianaid,
    amp_activity_version.amp_theme_id,
    amp_activity_version.amp_categ_val_modality_id,
    amp_activity_version.amp_team_id, amp_activity_version.author,
    amp_activity_version.activity_creator,
    amp_activity_version.approval_status, amp_activity_version.line_min_rank,
    amp_activity_version.plan_min_rank, amp_activity_version.customfield1,
    amp_activity_version.customfield2, amp_activity_version.customfield3,
    amp_activity_version.customfield4, amp_activity_version.customfield5,
    amp_activity_version.customfield6, amp_activity_version.approvedby,
    amp_activity_version.approvaldate, amp_activity_version.chapter_code,
    amp_activity_version.budget_sector,
    amp_activity_version.budget_organization,
    amp_activity_version.budget_department,
    amp_activity_version.budget_program,
    amp_activity_version.amp_activity_group_id,
    amp_activity_version.amp_activity_previous_version_id,
    amp_activity_version.modified_date, amp_activity_version.modified_by,
    amp_activity_version.iati_last_update_date, amp_activity_version.deleted,
    amp_activity_version.merged_activity, amp_activity_version.merge_source1,
    amp_activity_version.merge_source2
FROM amp_activity_version, amp_activity_group
WHERE ((amp_activity_version.amp_activity_id =
    amp_activity_group.amp_activity_last_version_id) AND
    ((amp_activity_version.deleted IS NULL) OR (amp_activity_version.deleted = false)));			
            </lang>
		</script>
	</apply>
</tns:patch>
