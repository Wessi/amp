<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="false" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
    <jira>AMP-8308</jira>
    <keyword>reports</keyword>
    <keyword>columns</keyword>
    <author>Medea Gugushvili</author>
    <description>remove duplicate columns from amp_columns table</description>

    <apply>
        <script>
            <lang type="mysql" delimiter=";">
                CREATE TEMPORARY TABLE IF NOT EXISTS tmp_amp_columns
                Select tb1.columnname,tb1.columnId remainCol, tb2.columnId forUpdate
                FROM
                (SELECT columnname,columnId,count(*) FROM amp_columns GROUP BY columnname having  count(columnname) > 1 ) as tb1
                inner join amp_columns tb2 on tb1.columnname=tb2.columnname
                where tb2.columnId!=tb1.columnId
                order by tb1.columnname;

                update amp_report_column tb1 inner join
                tmp_amp_columns
                tb0 on tb1.columnId=tb0.forUpdate
                set tb1.columnId=tb0.remainCol;

                update amp_report_hierarchy tb2 inner join
                tmp_amp_columns
                tb0 on tb2.columnId=tb0.forUpdate
                set tb2.columnId=tb0.remainCol;

                update amp_columns_filters tb3 inner join
                tmp_amp_columns
                tb0 on tb3.column_id=tb0.forUpdate
                set tb3.column_id=tb0.remainCol;

                delete from amp_columns where  columnId in (select forUpdate from tmp_amp_columns) ;

                drop temporary table tmp_amp_columns;
            </lang>
        </script>
    </apply>
</tns:patch>

