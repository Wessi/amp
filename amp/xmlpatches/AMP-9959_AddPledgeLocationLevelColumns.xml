<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-9959</jira>
  <keyword>xmlpatcher</keyword>
  <author>Mauricio</author>
  <description>This patch add zone and district columns to pledge reports</description>
  
  <apply>
    <script>
      <lang delimiter=";" type="postgres">
     					DELETE FROM amp_columns WHERE columnName ='Pledges Zones';
			INSERT INTO amp_columns (columnid, columnName, aliasName, cellType, extractorView)
			VALUES(nextval('amp_columns_seq'), 'Pledges Zones', '', 'org.dgfoundation.amp.ar.cell.TextCell','v_pledges_zones');
			DELETE FROM amp_columns WHERE columnName ='Pledges Districts';
			INSERT INTO amp_columns (columnid, columnName, aliasName, cellType, extractorView)
			VALUES(nextval('amp_columns_seq'), 'Pledges Districts', '', 'org.dgfoundation.amp.ar.cell.TextCell','v_pledges_districts');
			
			DROP VIEW v_pledges_regions;
			
			CREATE OR REPLACE VIEW v_pledges_regions AS 
			select 
			    ra.pledge_id AS pledge_id,
			    getLocationName(getLocationIdByImplLoc(cvl.id,'Region')) AS location_name,
			    getLocationIdByImplLoc(cvl.id,'Region') AS location_id,
			    sum(ra.location_percentage) AS location_percentage 
			  from 
			     ((amp_funding_pledges_location ra join amp_category_value_location cvl on((ra.location_id = cvl.id)))) 
			  where 
			    ((ra.location_id = cvl.id) and (getLocationIdByImplLoc(cvl.id,'Region') is not null)) 
			  group by 
			    ra.pledge_id,getLocationIdByImplLoc(cvl.id,'Region');
						
			CREATE OR REPLACE VIEW v_pledges_zones AS 
			select 
			    ra.pledge_id AS pledge_id,
			    getLocationName(getLocationIdByImplLoc(cvl.id,'Zone')) AS location_name,
			    getLocationIdByImplLoc(cvl.id,'Zone') AS location_id,
			    sum(ra.location_percentage) AS location_percentage 
			  from 
			     ((amp_funding_pledges_location ra join amp_category_value_location cvl on((ra.location_id = cvl.id)))) 
			  where 
			    ((ra.location_id = cvl.id) and (getLocationIdByImplLoc(cvl.id,'Zone') is not null)) 
			  group by 
			    ra.pledge_id,getLocationIdByImplLoc(cvl.id,'Zone');
			
			CREATE OR REPLACE VIEW v_pledges_districts AS 
			select 
			    ra.pledge_id AS pledge_id,
			    getLocationName(getLocationIdByImplLoc(cvl.id,'District')) AS location_name,
			    getLocationIdByImplLoc(cvl.id,'District') AS location_id,
			    sum(ra.location_percentage) AS location_percentage 
			  from 
			     ((amp_funding_pledges_location ra join amp_category_value_location cvl on((ra.location_id = cvl.id)))) 
			  where 
			    ((ra.location_id = cvl.id) and (getLocationIdByImplLoc(cvl.id,'District') is not null)) 
			  group by 
			    ra.pledge_id,getLocationIdByImplLoc(cvl.id,'District');
			
    	</lang>
    </script>
  </apply>

</tns:patch>
