<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-13388</jira>
  <keyword>issues</keyword>
  <keyword>measure</keyword>
  <keyword>actor</keyword>
  <author>Alex</author>
  <description>Creating hierarchy display in reports for issues,measure,actor</description>
  
  <trigger type="all">
      <condition  type="entryInTableMissing" tablename="amp_columns" columnname="extractorview" columnvalue="v_issues_measure_actors" />
  </trigger>
  
  <apply>
    <script>
      <lang delimiter=";" type="postgres">
		CREATE OR REPLACE VIEW v_issues_measure_actors AS 
		SELECT i.amp_activity_id, 
			xmlelement(name list, 
			xmlagg(xmlelement(name issue, xmlelement(name date,date(i.issuedate)),xmlelement(name description,i.name), l2.label2)))::varchar label1 
			FROM amp_issues i LEFT OUTER JOIN 
			(SELECT m.amp_issue_id, 
				xmlelement(name list, 
				xmlagg(xmlelement(name measure,xmlelement(name description, m.name), l3.label3))) label2 
				FROM amp_measure m LEFT OUTER JOIN 
				(select a.amp_measure_id,  
					xmlelement(name list, 
					xmlagg(xmlelement(name actor, xmlelement(name description, a.name))) ) label3 
					from amp_actor a 
					group by a.amp_measure_id) l3 
				ON (m.amp_measure_id=l3.amp_measure_id) 
				GROUP BY m.amp_issue_id) l2 
			ON (i.amp_issue_id=l2.amp_issue_id)  
			GROUP BY i.amp_activity_id; 
		
 
 
		INSERT INTO amp_columns (columnId,columnName,aliasName,cellType,extractorView) VALUES 
		(nextval('amp_columns_seq'),'Issues / Measures / Actors','issues_measure_actors','org.dgfoundation.amp.ar.cell.XmlHierarchyCell','v_issues_measure_actors');
      </lang>
    </script>
  </apply>

</tns:patch>
