<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-9868</jira>
  <keyword>category_manager</keyword>
  <keyword>budget</keyword>
  <author>Alex</author>
  <description>This moves the budget field backend to the category manager</description>
  <trigger type="all">
      <condition  type="entryInTableExists" tablename="amp_category_class" columnname="keyName" columnvalue="activity_budget" />
  </trigger>  
  <apply>
    <script>
      <lang delimiter=";" type="postgres">
     INSERT INTO amp_category_class (id,category_name, keyName, description, is_multiselect, is_ordered) 
	VALUES (nextval('amp_category_class_seq'),'Activity Budget', 'activity_budget', 'Please make sure you have values Off and On in this category !', false, true);
	
INSERT INTO amp_category_value (id,category_value, amp_category_class_id, index_column ) 
	SELECT nextval('amp_category_value_seq'),'Off',id,0 FROM amp_category_class where keyName='activity_budget'; 
INSERT INTO amp_category_value (id,category_value, amp_category_class_id, index_column ) 
	SELECT nextval('amp_category_value_seq'),'On',id,1 FROM amp_category_class where keyName='activity_budget'; 
INSERT INTO amp_category_value (id,category_value, amp_category_class_id, index_column ) 
	SELECT nextval('amp_category_value_seq'),'Treasure',id,2 FROM amp_category_class where keyName='activity_budget'; 
	
INSERT INTO amp_activities_categoryvalues (amp_activity_id, amp_categoryvalue_id) 
	SELECT a.amp_activity_id, acv.id FROM amp_activity a, amp_category_value acv, amp_category_class acc 
		where acv.amp_category_class_id=acc.id AND a.budget=acv.index_column AND 
			acc.keyName='activity_budget';
			

CREATE or REPLACE VIEW v_on_off_budget AS 
		SELECT a.amp_activity_id AS amp_activity_id,
		case 
			when acv.category_value='On' then 'yes' 
			when acv.category_value='Off' then 'no' 
			when acv.id is null then 'unallocated' 
			else acv.category_value||'' 
		end as budget 
		
		
		FROM 
		amp_activities_categoryvalues aac  
		 JOIN amp_category_value acv on aac.amp_categoryvalue_id=acv.id 
		 JOIN amp_category_class acc on (acc.id=acv.amp_category_class_id AND acc.keyName='activity_budget') 
		 RIGHT JOIN amp_activity a ON  a.amp_activity_id=aac.amp_activity_id 
		
		order by a.amp_activity_id; 

UPDATE amp_fields_visibility set name='On/Off/Treasure Budget' where name='On/Off Budget';
UPDATE amp_columns set columnName='On/Off/Treasure Budget' where columnName='On/Off Budget';
      
      </lang>
    </script>
  </apply>

</tns:patch>
