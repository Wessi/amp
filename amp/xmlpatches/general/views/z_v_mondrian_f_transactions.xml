<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-18110</jira>
	<keyword>Views</keyword>
	<author>Constantin Dolghier</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger>
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
				<!-- donor transactions -->
				
				DROP VIEW IF EXISTS v_mondrian_pure_transactions CASCADE;

CREATE OR REPLACE VIEW v_mondrian_pure_transactions AS 
SELECT
	aa.amp_activity_id AS amp_activity_id,
	f.amp_funding_id AS amp_funding_id,
	fd.amp_fund_detail_id AS amp_fund_detail_id,
	fd.transaction_type AS transaction_type,
	fd.adjustment_type AS adjustment_type,
	fd.transaction_date AS transaction_date,
	to_char(fd.transaction_date, 'J')::integer AS date_code,

	CASE
		WHEN (fd.amp_currency_id != (SELECT amp_currency_id FROM amp_currency WHERE currency_code = (SELECT settingsvalue FROM amp_global_settings WHERE settingsname = 'Base Currency'))) AND (fd.fixed_exchange_rate IS NOT NULL) AND (fd.fixed_exchange_rate > 0) THEN fd.transaction_amount / fd.fixed_exchange_rate 
		ELSE fd.transaction_amount 
	END as transaction_amount,
	CASE 
		WHEN (fd.amp_currency_id != (SELECT amp_currency_id FROM amp_currency WHERE currency_code = (SELECT settingsvalue FROM amp_global_settings WHERE settingsname = 'Base Currency'))) AND (fd.fixed_exchange_rate IS NOT NULL) AND (fd.fixed_exchange_rate > 0) THEN 
			(SELECT amp_currency_id FROM amp_currency WHERE currency_code = (SELECT settingsvalue FROM amp_global_Settings WHERE settingsname = 'Base Currency')) 
		ELSE fd.amp_currency_id
	END as currency_id,	
	
	CASE WHEN src_role.role_code='DN' THEN f.amp_donor_org_id ELSE 999888777 END AS donor_id,
	f.financing_instr_category_value AS financing_instrument_id,
	f.type_of_assistance_category_va AS terms_of_assistance_id,
	f.funding_status_category_va AS funding_status_id,
	f.mode_of_payment_category_va AS mode_of_payment_id,
	
	COALESCE(f.agreement, 999999999) AS agreement_id,
	
    fd.capital_spend_percent AS capital_spend_percent,
    fd.disaster_response AS disaster_response,
    fd.pledge_id AS pledge_id,
     
	src_role.role_code AS src_role,
	dest_role.role_code AS dest_role,
	fd.recipient_org_id AS dest_org_id,
	
	aa.draft AS draft,
	aa.deleted AS deleted,
	(select COUNT(*) from amp_activity_group aag WHERE aag.amp_activity_last_version_id = aa.amp_activity_id) AS is_last_version
          
	FROM amp_activity_version aa JOIN amp_funding f ON aa.amp_activity_id = f.amp_activity_id
		JOIN amp_funding_detail fd ON f.amp_funding_id = fd.amp_funding_id
		LEFT JOIN amp_role src_role ON src_role.amp_role_id = f.source_role_id
		LEFT JOIN amp_role dest_role ON dest_role.amp_role_id = fd.recipient_role_id
		
	WHERE (transaction_date BETWEEN '1970-1-1' AND '2050-1-1');
			</lang>
		</script>
	</apply>
</tns:patch>