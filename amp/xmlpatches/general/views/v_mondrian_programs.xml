<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-17836</jira>
	<keyword>Views</keyword>
	<author>Constantin Dolghier</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger>
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
				DROP VIEW IF EXISTS v_mondrian_programs;
			    CREATE OR REPLACE VIEW v_mondrian_programs AS 
					SELECT th.amp_theme_id, th.parent_theme_id, th.theme_code, th.name,
						line.program_setting_id AS program_setting_id, line.program_setting_name AS program_setting_name,
						b0.amp_theme_id AS id0, b0.name AS name0,
						b1.amp_theme_id AS id1, b1.name AS name1,
						b2.amp_theme_id AS id2, b2.name AS name2,
						b3.amp_theme_id AS id3, b3.name AS name3,
						b4.amp_theme_id AS id4, b4.name AS name4,
						b5.amp_theme_id AS id5, b5.name AS name5,
						b6.amp_theme_id AS id6, b6.name AS name6,
						b7.amp_theme_id AS id7, b7.name AS name7,
						b8.amp_theme_id AS id8, b8.name AS name8
						FROM amp_theme th JOIN all_programs_with_levels line ON th.amp_theme_id = line.amp_theme_id
   							LEFT JOIN amp_theme b0 ON b0.amp_theme_id = line.id0
							LEFT JOIN amp_theme b1 ON b1.amp_theme_id = line.id1
							LEFT JOIN amp_theme b2 ON b2.amp_theme_id = line.id2
							LEFT JOIN amp_theme b3 ON b3.amp_theme_id = line.id3
							LEFT JOIN amp_theme b4 ON b4.amp_theme_id = line.id4
							LEFT JOIN amp_theme b5 ON b5.amp_theme_id = line.id5
							LEFT JOIN amp_theme b6 ON b6.amp_theme_id = line.id6
							LEFT JOIN amp_theme b7 ON b7.amp_theme_id = line.id7
							LEFT JOIN amp_theme b8 ON b8.amp_theme_id = line.id8
							
					UNION ALL
					
						SELECT 999999999, null, 'Undefined', 'Undefined', null, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined',
							999999999, 'Undefined'
							
						ORDER BY amp_theme_id;
			</lang>
		</script>
	</apply>
</tns:patch>
