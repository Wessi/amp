<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-14167</jira>
	<keyword>Views</keyword>
	<author>Alexandru Artimon</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger> 
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
					DROP VIEW IF EXISTS v_pledges_funding;
			    	CREATE OR REPLACE VIEW v_pledges_funding AS 
			    	SELECT ap.id AS pledgeid, ap.title, COALESCE(ap.contactname, ''::character varying) AS contact_name, COALESCE(ap.contactemail, ''::character varying) AS contact_email, ((((apd.amount * COALESCE(fps.sector_percentage, (100)::double precision)) / (100)::double precision) * COALESCE(fpl.location_percentage, (100)::double precision)) / (100)::double precision) AS amount, apd.id AS amp_fund_detail_id, to_date(('02 Jan '::text || (apd.year)::text), 'DD Mon YYYY'::text) AS transaction_date, ac.currency_code, aorg.name AS org_name, aorg.amp_org_id AS org_id, 
			    		catv.category_value AS aid_modality_name, catv.id AS aid_modality_id,
			    		catv1.category_value AS type_of_assistance_name, catv1.id AS type_of_assistance_id,
			    		catv2.category_value AS pledge_type, catv2.id AS pledge_type_id,
			    		s.name AS p_sectorname, s.amp_sector_id as p_sector_id, fps.sector_percentage AS spercenatage, l.location_name AS region, l.id as region_id 
			    	FROM ((((((((((amp_funding_pledges ap JOIN amp_funding_pledges_details apd ON ((ap.id = apd.pledge_id))) 
			    	JOIN amp_category_value catv ON ((apd.aid_modality = catv.id))) 
			    	JOIN amp_category_value catv1 ON ((apd.type_of_assistance = catv1.id))) 
			    	JOIN amp_category_value catv2 ON ((apd.pledge_type = catv2.id))) 
			    	JOIN amp_currency ac ON ((apd.currency = ac.amp_currency_id))) 
			    	JOIN amp_organisation aorg ON ((ap.amp_org_id = aorg.amp_org_id))) 
			    	JOIN amp_funding_pledges_sector fps ON ((ap.id = fps.pledge_id))) 
			    	JOIN amp_sector s ON ((fps.amp_sector_id = s.amp_sector_id))) 
			    	JOIN amp_funding_pledges_location fpl ON ((ap.id = fpl.pledge_id))) 
			    	LEFT JOIN amp_category_value_location l ON ((fpl.location_id = l.id))) 
			    	ORDER BY ap.id, apd.id, aorg.amp_org_id, s.amp_sector_id, l.id, ap.title, COALESCE(ap.contactname, ''::character varying), ap.contactemail, apd.amount, fps.sector_percentage, fpl.location_percentage, apd.year, ac.currency_code, aorg.name, catv.category_value, catv1.category_value, catv2.category_value, s.name, l.location_name;;;
        		</lang>
		</script>
	</apply>
</tns:patch>
