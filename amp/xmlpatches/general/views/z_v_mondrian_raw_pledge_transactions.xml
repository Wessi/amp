<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-18272</jira>
	<keyword>Views</keyword>
	<author>Constantin Dolghier</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger>
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
				DROP VIEW IF EXISTS v_mondrian_raw_pledge_transactions CASCADE;
			    CREATE OR REPLACE VIEW v_mondrian_raw_pledge_transactions AS 
SELECT <!-- pledge funding -->
	pf.pledge_id AS pledge_id,
	pf.amp_pledge_funding_id AS amp_fund_detail_id,
	pf.transaction_type,
	pf.adjustment_type,
	pf.transaction_date,
	to_char(pf.transaction_date, 'J')::integer AS date_code,
	to_char(pf.transaction_date, gs.date_format) AS transaction_start_date,
	pf.transaction_end_date AS transaction_end_date,
	to_char(pf.transaction_date, gs.date_format) || ' - ' || pf.transaction_end_date AS transaction_range,
	pf.transaction_amount,
	pf.currency_id,
	pf.originating_org_id,
	999999999 AS financing_instrument_id,
	pf.type_of_assistance AS terms_of_assistance_id,
	999999999 AS funding_status_id,
	999999999 AS mode_of_payment_id,
	pf.status_id,
	pf.aid_modality AS modality_id,
	999999999 AS type_of_cooperation_id,
	999999999 AS type_of_implementation_id,
	999999999 AS procurement_system_id,
	
	CAST(NULL as bigint) AS component_id,
	pf.agreement_id AS agreement_id,
	
	NULL AS capital_spend_percent,
	NULL AS disaster_response,
	
	cast ('DN' as text) as src_role,
	cast (NULL as text) as dest_role,
	cast (NULL as bigint) as dest_org_id,
	
	pf.related_activity_id AS related_entity_id
	
FROM v_mondrian_pledge_transactions pf, 
     (SELECT settingsvalue as date_format FROM amp_global_settings WHERE settingsname LIKE 'Default Date Format') AS gs 
WHERE (pf.transaction_date BETWEEN '1970-1-1' AND '2050-1-1');
			</lang>
		</script>
	</apply>
</tns:patch>