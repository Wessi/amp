<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-18110</jira>
	<keyword>Views</keyword>
	<author>Constantin Dolghier</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger> 
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
				DROP VIEW IF EXISTS v_mondrian_activity_long_texts;
				CREATE OR REPLACE VIEW v_mondrian_activity_long_texts AS
				
SELECT a.amp_activity_id,
	langs.code AS language,
	descr.body AS descr_body,
	ll.body AS lessons_learned_body,
	objectives.body AS objectives_body,
	results.body AS results_body,
	purpose.body AS purpose_body,
	projectcomments.body AS projectcomments_body,
	project_impact.body AS project_impact_body,
	activity_summary.body AS activity_summary_body,
	conditionality.body AS conditionality_body,
	project_management.body AS project_management_body,
	equalopportunity.body AS equalopportunity_body,
	environment.body AS environment_body,
	minorities.body AS minorities_body,
	program_description.body AS program_description_body

FROM amp_activity_version a 
	JOIN dg_site_trans_lang_map langs ON langs.site_id = 3
	LEFT JOIN dg_editor_filtered descr ON descr.editor_key = a.description AND descr.language = langs.code AND descr.site_id = 'amp'
	LEFT JOIN dg_editor_filtered ll ON ll.editor_key = a.lessons_learned AND ll.language = langs.code AND ll.site_id = 'amp'
	LEFT JOIN dg_editor_filtered objectives ON objectives.editor_key = a.objectives AND objectives.language = langs.code AND objectives.site_id = 'amp'
	LEFT JOIN dg_editor_filtered results ON results.editor_key = a.results AND results.language = langs.code AND results.site_id = 'amp'
	LEFT JOIN dg_editor_filtered purpose ON purpose.editor_key = a.purpose AND purpose.language = langs.code AND purpose.site_id = 'amp'
	LEFT JOIN dg_editor_filtered projectcomments ON projectcomments.editor_key = a.projectcomments AND projectcomments.language = langs.code AND projectcomments.site_id = 'amp'
	LEFT JOIN dg_editor_filtered project_impact ON project_impact.editor_key = a.project_impact AND project_impact.language = langs.code AND project_impact.site_id = 'amp'
	LEFT JOIN dg_editor_filtered activity_summary ON activity_summary.editor_key = a.activity_summary AND activity_summary.language = langs.code AND activity_summary.site_id = 'amp'
	LEFT JOIN dg_editor_filtered conditionality ON conditionality.editor_key = a.conditionality AND conditionality.language = langs.code AND conditionality.site_id = 'amp'
	LEFT JOIN dg_editor_filtered project_management ON project_management.editor_key = a.project_management AND project_management.language = langs.code AND project_management.site_id = 'amp'
	LEFT JOIN dg_editor_filtered equalopportunity ON equalopportunity.editor_key = a.equalopportunity AND equalopportunity.language = langs.code AND equalopportunity.site_id = 'amp'
	LEFT JOIN dg_editor_filtered environment ON environment.editor_key = a.environment AND environment.language = langs.code AND environment.site_id = 'amp'
	LEFT JOIN dg_editor_filtered minorities ON minorities.editor_key = a.minorities AND minorities.language = langs.code AND minorities.site_id = 'amp'
	LEFT JOIN dg_editor_filtered program_description ON program_description.editor_key = a.program_description AND program_description.language = langs.code AND program_description.site_id = 'amp';	

<!--  ORDER BY a.amp_activity_id; -->
			</lang>
		</script>
	</apply>
</tns:patch>
