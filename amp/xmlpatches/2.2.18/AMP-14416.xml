<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
    <jira>AMP-14416</jira>
    <keyword>Pledges Sectors</keyword>
    <keyword></keyword>
    <author>Diego</author>
    <description>Add pledges sectors column</description> 
       <apply>
        <script>
            <lang  delimiter=";" type="postgres">
            	INSERT INTO amp_columns (columnId,columnName,aliasName,cellType,extractorView) VALUES 
				(nextval('amp_columns_seq'),'Pledges sectors','','org.dgfoundation.amp.ar.cell.TextCell','v_pledges_sectors');
				
				CREATE OR REPLACE VIEW v_pledges_sectors AS 
 				SELECT ps.pledge_id, getsectorname(getparentsectorid(s.amp_sector_id)) AS sectorname, getparentsectorid(s.amp_sector_id) AS amp_sector_id, sum(ps.sector_percentage) AS sector_percentage, s.amp_sec_scheme_id AS amp_sector_scheme_id, ss.sec_scheme_name
   				FROM amp_sector_scheme ss
   				JOIN amp_sector s ON s.amp_sec_scheme_id = ss.amp_sec_scheme_id
   				JOIN amp_funding_pledges_sector ps ON ps.amp_sector_id = s.amp_sector_id
  				GROUP BY ps.pledge_id, getparentsectorid(s.amp_sector_id), s.amp_sec_scheme_id, ss.sec_scheme_name
  				ORDER BY ps.pledge_id, getsectorname(getparentsectorid(s.amp_sector_id));
            </lang>
        </script>
    </apply>
</tns:patch>
