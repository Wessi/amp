<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">

	<jira>AMP-5143</jira>
	<keyword>translations</keyword>
	<keyword>hashcode</keyword>
	<author>Irakli Kobiashvili</author>
	<description>
		Removes translations with old keys. 
		Backup is done in dg_message_backup table.
		Also invalidates translations lucene index to trigger its rebuild.
		Patch ensures that:
		1)hash code patch has been ran agains this db.
		2)there are records with old keys, othervise there is no mean to vaste resources on backup table.
		3)there are records with new keys. Just to ensure that a)hashcode convertion patch really ran b) we will notleave AMp without translations.
		If any of these conditions are FALSE then patch will not apply.
	</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="a">
				<lang type="sql">SELECT count(*) FROM amp_global_settings WHERE settingsName LIKE 'Translation hashcode patch'</lang>
			</script>
			<test>a.intValue()==1</test>
		</condition>
		<condition type="custom">
			<script returnVar="c">
				<lang type="sql">SELECT count(*) FROM dg_message WHERE message_key NOT REGEXP '^-?[0-9]+$'</lang>
			</script>
			<test>c.intValue()>0</test>
		</condition>
		<condition type="custom">
			<script returnVar="d">
				<lang type="sql">SELECT count(*) FROM dg_message WHERE message_key REGEXP '^-?[0-9]+$'</lang>
			</script>
			<test>d.intValue()>0</test>
		</condition>
	</trigger>
	<apply>
		<script>
			<lang type="sql">
   				DROP TABLE IF EXISTS dg_message_backup; 
   			</lang>
		</script>
		<script>
			<lang type="sql">
				CREATE TABLE IF NOT EXISTS dg_message_backup AS SELECT * FROM dg_message;
			</lang>
		</script>
		<script>
			<lang type="sql">
				DELETE FROM amp_lucene_index WHERE idxName LIKE 'translation'; 
   			</lang>
		</script>
		<script>
			<lang type="sql">
				DELETE m FROM dg_message AS m WHERE m.message_key NOT REGEXP '^-?[0-9]+$'; 
   			</lang>
		</script>
	</apply>

</tns:patch>
