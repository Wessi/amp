<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="false" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
    <jira>AMP-8212</jira>
    <keyword>Gis</keyword>
    <keyword>PieChart</keyword>
    <author>Medea Gugushvili</author>
    <description>Update function so that it will return amounts in usd and not in the base currency</description>
       <apply>
        <script>
            <lang  delimiter="$" type="mysql">
                DROP FUNCTION IF EXISTS getTransactionAmmountUSD$
                CREATE FUNCTION getTransactionAmmountUSD(fdId long) RETURNS double
                BEGIN
                declare r double;
                declare code char(3);
                declare dateFD datetime;
                declare amount double;
                select cur.currency_code, transaction_date, transaction_amount,fixed_exchange_rate into code,dateFD,amount,r from amp_currency cur inner join amp_funding_detail det on cur.amp_currency_id=det.amp_currency_id where det.amp_fund_detail_id =fdId;
                if r is not null then return amount/r*getExchange("USD",dateFD); end if;
                return amount/getExchange(code,dateFD)*getExchange("USD",dateFD);
                END$
            </lang>
        </script>
    </apply>
</tns:patch>
