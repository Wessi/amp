<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true" xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
  <jira>AMP-11612</jira>
  <author>Dare</author>
  <description>new views for public page</description>
  <apply>
    <script>
      <lang delimiter=";" type="postgres">
			 create or replace view v_act_pp_details as select act.amp_activity_id,act.name,act.activity_start_date,act.activity_close_date from amp_activity_version act ORDER BY act.amp_activity_id;

  create or replace view v_act_pp_sectors as (SELECT sa.amp_activity_id, getsectorname(getparentsectorid(s.amp_sector_id)) AS sector_name,getparentsectorid(s.amp_sector_id) AS amp_sector_id   
   FROM amp_sector_scheme ss JOIN amp_classification_config cc ON cc.name = 'Primary'  AND cc.classification_id = ss.amp_sec_scheme_id 
   JOIN amp_sector s ON s.amp_sec_scheme_id = ss.amp_sec_scheme_id    JOIN amp_activity_sector sa ON sa.amp_sector_id = s.amp_sector_id AND 
   sa.classification_config_id = cc.id GROUP BY sa.amp_activity_id, getparentsectorid(s.amp_sector_id) 
  ORDER BY sa.amp_activity_id, getsectorname(getparentsectorid(s.amp_sector_id))) ;

  create or replace view v_act_pp_regions as (SELECT ra.amp_activity_id,l.region_location_id AS region_id,l.region   FROM amp_activity_location ra 
   JOIN amp_location l ON ra.amp_location_id = l.amp_location_id 
  WHERE l.region_location_id IS NOT NULL 
  GROUP BY ra.amp_activity_id, l.region_location_id, l.region 
  ORDER BY ra.amp_activity_id, l.region);


  create or replace view v_act_pp_funding_data as (select f.amp_activity_id,f.amp_funding_id, fd.amp_fund_detail_id,d.name as donor_name,fd.transaction_type,fd.transaction_amount,c.currency_code, fd.fixed_exchange_rate from 
  amp_funding f, amp_funding_detail fd,amp_currency c, amp_organisation d where f.amp_funding_id = fd.amp_funding_id and d.amp_org_id = f.amp_donor_org_id 
  and c.amp_currency_id = fd.amp_currency_id and fd.transaction_type in (0,1) ORDER BY f.amp_activity_id);
      </lang>
    </script>
  </apply>

</tns:patch>
