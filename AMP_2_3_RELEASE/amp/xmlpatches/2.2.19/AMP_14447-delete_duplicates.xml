<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="true" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-14447</jira>
	<keyword>Users</keyword>
	<author>Constantin Dolghier</author>
	<description>delete banned user which have their emails equal to non-banned users'</description>
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
				UPDATE dg_user A
					SET email = CONCAT(email, CONCAT('__dummy__', random()::text))
				WHERE (A.banned IS TRUE) AND ((SELECT COUNT(*) FROM dg_user B WHERE lower(B.email) = lower(A.email) AND B.banned IS FALSE) &gt; 0) ;;
				
				UPDATE dg_user A 
					SET email = CONCAT(email, CONCAT('__dummy__', random()::text))
				WHERE (SELECT COUNT (*) FROM dg_user B WHERE lower(B.email) = lower(A.email) AND B.id &lt; A.id) &gt; 0;
			</lang>
		</script>
	</apply>
</tns:patch>
