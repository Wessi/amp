<?xml version="1.0" encoding="UTF-8"?>
<tns:patch closeOnSuccess="false" retryOnFail="true"
	xmlns:tns="http://docs.ampdev.net/schemas/xmlpatcher" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://docs.ampdev.net/schemas/xmlpatcher ../doc/xmlpatcher.xsd ">
	<jira>AMP-14167</jira>
	<keyword>Views</keyword>
	<author>Alexandru Artimon</author>
	<description>recreate view, this will always be the last version of the view</description>
	<trigger type="all">
		<condition type="custom">
			<script returnVar="val">
				<lang type="sql">
					SELECT settingsvalue FROM amp_global_settings where settingsname='Recreate the views on the next server restart';
				</lang>
			</script>
 			<test>val.equalsIgnoreCase("true")</test>
		</condition>
	</trigger> 
	<apply>
		<script>
			<lang delimiter=";" type="postgres">
			    	CREATE OR REPLACE VIEW v_donor_funding_cached AS SELECT aa.amp_activity_id, f.amp_funding_id, fd.amp_fund_detail_id, fd.transaction_type, fd.adjustment_type, fd.transaction_date, (fd.transaction_amount * (((((((((((COALESCE(rc.location_percentage, (100)::double precision) / (100)::double precision) * COALESCE(pp.program_percentage, (100)::double precision)) / (100)::double precision) * COALESCE(sp.program_percentage, (100)::double precision)) / (100)::double precision) * COALESCE(np.program_percentage, (100)::double precision)) / (100)::double precision) * COALESCE(secs.sector_percentage, (100)::double precision)) / (100)::double precision) * COALESCE(s.sector_percentage, (100)::double precision)) / (100)::double precision)) AS transaction_amount, d.name AS donor_name, c.currency_code, cval.id AS terms_assist_id, cval.category_value AS terms_assist_name, fd.fixed_exchange_rate, b.org_grp_name, ot.org_type AS donor_type_name, cval2.category_value AS financing_instrument_name, cval2.id AS financing_instrument_id, d.amp_org_id AS org_grp_id, ot.amp_org_type_id AS org_type_id, fd.disbursement_order_rejected AS disb_ord_rej, s.sectorname AS p_sectorname, s.sec_scheme_name AS p_amp_sec_scheme_name, s.sector_percentage AS sector_precentage, rc.region, pp.name AS primary_program_name, ppl1.name AS ppl1_name, ppl2.name AS ppl2_name, ppl3.name AS ppl3_name, ppl4.name AS ppl4_name, ppl5.name AS ppl5_name, ppl6.name AS ppl6_name, ppl7.name AS ppl7_name, ppl8.name AS ppl8_name, sp.name AS secondary_program_name, spl1.name AS spl1_name, spl2.name AS spl2_name, spl3.name AS spl3_name, spl4.name AS spl4_name, spl5.name AS spl5_name, spl6.name AS spl6_name, spl7.name AS spl7_name, spl8.name AS spl8_name, np.name AS national_program_name, npl1.name AS npl1_name, npl2.name AS npl2_name, npl3.name AS npl3_name, npl4.name AS npl4_name, npl5.name AS npl5_name, npl6.name AS npl6_name, npl7.name AS npl7_name, npl8.name AS npl8_name, ssub.sectorname AS s_sub_sector_name, secs.sectorname AS s_sectorname, ss.sec_scheme_name AS s_amp_sec_scheme_name FROM ((((((((((((((((((((((((((((((((((((((((cached_amp_activity aa JOIN amp_funding f ON ((aa.amp_activity_id = f.amp_activity_id))) JOIN amp_funding_detail fd ON ((f.amp_funding_id = fd.amp_funding_id))) JOIN amp_category_value cval ON ((f.type_of_assistance_category_va = cval.id))) JOIN amp_currency c ON ((fd.amp_currency_id = c.amp_currency_id))) LEFT JOIN amp_organisation d ON ((f.amp_donor_org_id = d.amp_org_id))) JOIN amp_org_group b ON ((d.org_grp_id = b.amp_org_grp_id))) JOIN amp_org_type ot ON ((b.org_type = ot.amp_org_type_id))) JOIN amp_category_value cval2 ON ((f.financing_instr_category_value = cval2.id))) LEFT JOIN cached_v_sectors s ON ((aa.amp_activity_id = s.amp_activity_id))) LEFT JOIN cached_v_secondary_sectors secs ON ((aa.amp_activity_id = secs.amp_activity_id))) LEFT JOIN cached_v_secondary_sub_sectors ssub ON ((aa.amp_activity_id = ssub.amp_activity_id))) LEFT JOIN amp_sector_scheme ss ON ((secs.amp_sector_scheme_id = ss.amp_sec_scheme_id))) JOIN cached_v_m_regions rc ON ((aa.amp_activity_id = rc.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_0 pp ON ((f.amp_activity_id = pp.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_1 ppl1 ON ((f.amp_activity_id = ppl1.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_2 ppl2 ON ((f.amp_activity_id = ppl2.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_3 ppl3 ON ((f.amp_activity_id = ppl3.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_4 ppl4 ON ((f.amp_activity_id = ppl4.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_5 ppl5 ON ((f.amp_activity_id = ppl5.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_6 ppl6 ON ((f.amp_activity_id = ppl6.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_7 ppl7 ON ((f.amp_activity_id = ppl7.amp_activity_id))) LEFT JOIN cached_v_primaryprogram_level_8 ppl8 ON ((f.amp_activity_id = ppl8.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_0 sp ON ((f.amp_activity_id = sp.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_1 spl1 ON ((f.amp_activity_id = spl1.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_2 spl2 ON ((f.amp_activity_id = spl2.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_3 spl3 ON ((f.amp_activity_id = spl3.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_4 spl4 ON ((f.amp_activity_id = spl4.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_5 spl5 ON ((f.amp_activity_id = spl5.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_6 spl6 ON ((f.amp_activity_id = spl6.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_7 spl7 ON ((f.amp_activity_id = spl7.amp_activity_id))) LEFT JOIN cached_v_secondaryprogram_level_8 spl8 ON ((f.amp_activity_id = spl8.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_0 np ON ((f.amp_activity_id = np.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_1 npl1 ON ((f.amp_activity_id = npl1.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_2 npl2 ON ((f.amp_activity_id = npl2.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_3 npl3 ON ((f.amp_activity_id = npl3.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_4 npl4 ON ((f.amp_activity_id = npl4.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_5 npl5 ON ((f.amp_activity_id = npl5.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_6 npl6 ON ((f.amp_activity_id = npl6.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_7 npl7 ON ((f.amp_activity_id = npl7.amp_activity_id))) LEFT JOIN cached_v_nationalobjectives_level_8 npl8 ON ((f.amp_activity_id = npl8.amp_activity_id))) GROUP BY fd.transaction_type, fd.amp_fund_detail_id, fd.disbursement_order_rejected, fd.adjustment_type, fd.transaction_amount, fd.transaction_date, f.amp_funding_id, aa.amp_activity_id, s.amp_sector_id, s.sectorname, secs.amp_sector_id, secs.sectorname, secs.amp_activity_id, ss.amp_sec_scheme_id, ot.org_type, ot.amp_org_type_id, d.amp_org_id, cval2.id, cval2.category_value, cval.category_value, cval.id, b.org_grp_name, fd.fixed_exchange_rate, c.currency_code, d.name, rc.region_id, rc.region, rc.amp_activity_id, pp.amp_program_id, ppl2.amp_program_id, ppl3.amp_program_id, ppl4.amp_program_id, ppl5.amp_program_id, ppl6.amp_program_id, ppl7.amp_program_id, ppl8.amp_program_id, sp.amp_program_id, spl2.amp_program_id, spl3.amp_program_id, spl4.amp_program_id, spl5.amp_program_id, spl6.amp_program_id, spl7.amp_program_id, spl8.amp_program_id, np.amp_program_id, npl1.amp_program_id, npl2.amp_program_id, npl3.amp_program_id, npl4.amp_program_id, npl5.amp_program_id, npl6.amp_program_id, npl7.amp_program_id, npl8.amp_program_id, rc.location_percentage, pp.program_percentage, sp.program_percentage, np.program_percentage, secs.sector_percentage, ssub.sector_percentage, s.sector_percentage, s.sec_scheme_name, pp.name, ppl1.name, ppl2.name, ppl3.name, ppl4.name, ppl5.name, ppl6.name, ppl7.name, ppl8.name, sp.name, spl1.name, spl2.name, spl3.name, spl4.name, spl5.name, spl6.name, spl7.name, spl8.name, np.name, npl1.name, npl2.name, npl3.name, npl4.name, npl5.name, npl6.name, npl7.name, npl8.name, ssub.sectorname, ss.sec_scheme_name ORDER BY aa.amp_activity_id, s.sectorname, fd.transaction_type, f.amp_funding_id;;;
        		</lang>
		</script>
	</apply>
</tns:patch>
